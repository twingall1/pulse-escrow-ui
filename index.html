<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Esteem ‚Üî WPLS Escrow</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;max-width:900px;margin:32px auto;padding:0 16px;color:#111}
  .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:18px 0}
  label{display:block;font-weight:600;margin-top:8px}
  input{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:8px}
  input[readonly]{background:#f7f7f7}
  button{cursor:pointer;border:0;border-radius:8px;padding:10px 12px;background:#0866ff;color:#fff;font-weight:700}
  button.secondary{background:#444}
  button.warn{background:#e76f00}
  button.ok{background:#16a34a}
  pre{background:#f6f8fa;padding:10px;border-radius:8px;overflow:auto}
  .row{display:flex;gap:10px}
  .row>*{flex:1}
  .log{min-height:80px;white-space:pre-wrap}
  a{color:#0866ff}
</style>
</head>
<body>
<div style="text-align:center;margin-top:20px;margin-bottom:30px;">
  <div style="font-size:4em;line-height:1;">üê¶‚Äç‚¨õ</div>
  <h1 style="margin:10px 0 5px;font-size:2em;">Esteem ‚Üî WPLS Escrow</h1>
  <p style="max-width:600px;margin:0 auto;font-size:1.1em;color:#333;">
    A Trustless escrow between two parties ‚Äî the seller deposits <strong>ESTEEM</strong>,
    the buyer pays with <strong>WPLS</strong>, and either side can settle (or refund after the deadline).
  </p>
</div>

<p id="net">üî¥ Not connected</p>
<div class="row">
  <button id="connect">Connect / Switch to PulseChain</button>
  <button id="reset" class="secondary">Reset</button>
</div>

<div class="card">
  <h3>Create Escrow (seller sets terms)</h3>
  <label>Seller address</label><input id="seller" placeholder="0xSeller..."/>
  <label>Buyer address</label><input id="buyer" placeholder="0xBuyer..."/>
  <label>ESTEEM (fixed)</label><input id="esteem" value="0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5" readonly/>
  <label>WPLS (fixed)</label><input id="wpls" value="0xA1077a294dDE1B09bB078844df40758a5D0f9a27" readonly/>
  <div class="row">
    <div><label>ESTEEM amount (tokens)</label><input id="amountSellHuman" placeholder="e.g. 100"/></div>
    <div><label>WPLS amount (tokens)</label><input id="amountBuyHuman" placeholder="e.g. 1.5"/></div>
  </div>
  <label>Deadline (minutes from now)</label><input id="mins" type="number" placeholder="e.g. 60"/>
  <button id="create">Create Escrow</button>
  <div id="createLog" class="log"></div>
  <div id="share"></div>
</div>

<div class="card">
  <h3>Interact With Escrow</h3>
  <input id="escrowAddr" placeholder="0xEscrow..."/>
  <div class="row"><button id="load" class="secondary">Load Summary</button><button id="copy" class="secondary">Copy Link</button></div>
  <pre id="summary">{}</pre>
  <div id="nextActions"></div>

  <h4>Seller</h4>
  <div class="row">
    <button id="checkAllowSeller" class="secondary">Check Allowance (ESTEEM‚ÜíEscrow)</button>
    <button id="approveSeller" class="ok">Approve ESTEEM</button>
    <button id="fundSeller" class="ok">Fund Seller</button>
  </div>

  <h4>Buyer</h4>
  <div class="row">
    <button id="checkAllowBuyer" class="secondary">Check Allowance (WPLS‚ÜíEscrow)</button>
    <button id="approveBuyer" class="ok">Approve WPLS</button>
    <button id="fundBuyer" class="ok">Fund Buyer</button>
  </div>

  <div class="row" style="margin-top:8px;">
    <button id="settle">Settle</button>
    <button id="refund" class="warn">Refund</button>
  </div>

  <div id="actionLog" class="log"></div>
</div>

<script>
/*** ====== CONFIG ====== ***/
const PULSE = "0x171";
const FACTORY_ADDRESS = "0x384e0a4dE045fD82134C2181d78EC2Ca13159ece"; // <‚Äî paste your deployed factory here
const ESTEEM_ADDR     = "0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5";
const WPLS_ADDR       = "0xA1077a294dDE1B09bB078844df40758a5D0f9a27";

const FACTORY_ABI = [
  "function create(address seller,address buyer,address esteem,address wpls,uint256 amountSell,uint256 amountBuy,uint256 deadline) external returns (address)",
  "event EscrowCreated(address indexed escrow,address indexed seller,address indexed buyer,address esteem,address wpls,uint256 amountSell,uint256 amountBuy,uint256 deadline)"
];
const ESCROW_ABI = [
  "function summary() view returns (address,address,address,address,uint256,uint256,uint256,bool,bool,uint8)",
  "function fundSeller() external",
  "function fundBuyer() external",
  "function settle() external",
  "function refund() external"
];
const ERC20_ABI = [
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 amount) returns (bool)"
];

/*** ====== STATE ====== ***/
let provider, signer, account, factory;
const $ = id => document.getElementById(id);
const toWei = x => ethers.parseUnits(String(x||"0"),18);
const fromWei = b => Number(ethers.formatUnits(b??0n,18));
function log(el,msg){el.textContent += (el.textContent?"\n":"")+msg;}
function set(el,msg){el.textContent = msg;}
function shareLink(addr){ return location.origin+location.pathname+"?escrow="+addr; }
function whoActsNext(s){
  const now = Math.floor(Date.now()/1000), after = now > s.deadline;
  const name = ["Created","SellerFunded","BuyerFunded","BothFunded","Completed","Cancelled"][s.status];
  if (name==="Completed") return "‚úÖ Trade completed.";
  if (name==="Cancelled") return "‚ö†Ô∏è Escrow cancelled.";
  if (s.sellerFunded && s.buyerFunded) return "Both funded ‚Üí Either party may click Settle.";
  if (s.sellerFunded && !s.buyerFunded) return after ? "Deadline passed ‚Üí Refund returns ESTEEM to seller." : "Seller funded ‚Üí Buyer must approve WPLS & Fund Buyer.";
  if (!s.sellerFunded && s.buyerFunded) return after ? "Deadline passed ‚Üí Refund returns WPLS to buyer." : "Buyer funded ‚Üí Seller must approve ESTEEM & Fund Seller.";
  return "No one funded yet ‚Üí Seller approve+fund; Buyer approve+fund.";
}

/*** ====== NETWORK ====== ***/
async function ensurePulse(){
  if(!window.ethereum) throw new Error("Install MetaMask");
  const id = await ethereum.request({method:"eth_chainId"});
  if(id!==PULSE){
    try{ await ethereum.request({method:"wallet_switchEthereumChain", params:[{chainId:PULSE}]}); }
    catch(e){
      if(e.code===4902){
        await ethereum.request({method:"wallet_addEthereumChain", params:[{
          chainId:PULSE, chainName:"PulseChain",
          nativeCurrency:{ name:"PLS", symbol:"PLS", decimals:18 },
          rpcUrls:["https://rpc.pulsechain.com"], blockExplorerUrls:["https://scan.pulsechain.com"]
        }]});
      } else { throw e; }
    }
  }
}

$("connect").onclick = async () => {
  try {
    await ensurePulse();
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = await provider.getSigner();
    account = await signer.getAddress();
    factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);
    set($("net"), "üü¢ Connected: "+account+" (PulseChain)");

    const q = new URLSearchParams(location.search).get("escrow");
    if (q) { $("escrowAddr").value = q; $("load").click(); }
  } catch (e) { set($("net"), "‚ùå "+(e.message||e)); }
};
$("reset").onclick = () => location.reload();

/*** ====== CREATE ESCROW ====== ***/
$("create").onclick = async () => {
  const out = $("createLog"); out.textContent = "";
  try {
    if (!signer) throw new Error("Connect wallet first");
    const seller = $("seller").value.trim();
    const buyer  = $("buyer").value.trim();
    if (!ethers.isAddress(seller) || !ethers.isAddress(buyer)) throw new Error("Invalid seller/buyer");
    const amountSell = toWei($("amountSellHuman").value.trim());
    const amountBuy  = toWei($("amountBuyHuman").value.trim());
    const deadline   = Math.floor(Date.now()/1000) + Number($("mins").value||0)*60;

    const tx = await factory.create(seller, buyer, ESTEEM_ADDR, WPLS_ADDR, amountSell, amountBuy, deadline);
    log(out, "Tx sent: "+tx.hash);

    const rc = await tx.wait();
    // Robust log parsing (avoids ‚Äúunknown‚Äù)
    const iface = new ethers.Interface(FACTORY_ABI);
    let escrowAddr = null;
    for (const lg of rc.logs) {
      try {
        const parsed = iface.parseLog(lg);
        if (parsed?.name === "EscrowCreated") { escrowAddr = parsed.args.escrow; break; }
      } catch {}
    }
    if (!escrowAddr) throw new Error("EscrowCreated event not found");
    log(out, "‚úÖ Escrow created at "+escrowAddr);
    $("escrowAddr").value = escrowAddr;
    $("share").innerHTML = `Share link: <a href="${shareLink(escrowAddr)}">${shareLink(escrowAddr)}</a>`;
  } catch (e) { log(out, "‚ùå "+(e.message||e)); }
};

/*** ====== SUMMARY / NEXT STEPS ====== ***/
$("load").onclick = async () => {
  const addr = $("escrowAddr").value.trim(), out = $("summary"), nxt = $("nextActions");
  try {
    const esc = new ethers.Contract(addr, ESCROW_ABI, provider || new ethers.BrowserProvider(window.ethereum));
    const s = await esc.summary();
    const data = {
      seller: s[0], buyer: s[1], esteem: s[2], wpls: s[3],
      amountSellWei: s[4].toString(), amountBuyWei: s[5].toString(),
      amountSell: Number(ethers.formatUnits(s[4],18))+" ESTEEM",
      amountBuy:  Number(ethers.formatUnits(s[5],18))+" WPLS",
      deadline: Number(s[6]),
      deadlineAt: new Date(Number(s[6])*1000).toLocaleString(),
      sellerFunded: s[7], buyerFunded: s[8], status: Number(s[9])
    };
    out.textContent = JSON.stringify(data, null, 2);
    $("nextActions").textContent = whoActsNext(data);
  } catch (e) { out.textContent = "‚ùå "+(e.message||e); }
};
$("copy").onclick = async () => {
  const a = $("escrowAddr").value.trim();
  await navigator.clipboard.writeText(shareLink(a));
};

/*** ====== ALLOWANCE & FUNDING ====== ***/
async function checkAllowance(tokenAddr, owner, spender) {
  const t = new ethers.Contract(tokenAddr, ERC20_ABI, provider || new ethers.BrowserProvider(window.ethereum));
  return await t.allowance(owner, spender);
}
async function approveTo(tokenAddr, spender, amount) {
  const t = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
  const tx = await t.approve(spender, amount);
  return await tx.wait();
}

$("checkAllowSeller").onclick = async () => {
  const logBox = $("actionLog");
  try {
    if (!signer) throw new Error("Connect wallet");
    $("load").click();
    const owner = await signer.getAddress();
    const spender = $("escrowAddr").value.trim();
    const a = await checkAllowance(ESTEEM_ADDR, owner, spender);
    log(logBox, `Seller allowance ESTEEM‚ÜíEscrow: ${a.toString()}`);
  } catch (e) { log(logBox, "‚ùå "+(e.message||e)); }
};
$("approveSeller").onclick = async () => {
  const logBox = $("actionLog");
  try {
    if (!signer) throw new Error("Connect wallet"); $("load").click();
    const sum = JSON.parse($("summary").textContent);
    const txr = await approveTo(ESTEEM_ADDR, $("escrowAddr").value.trim(), BigInt(sum.amountSellWei));
    log(logBox, "‚úÖ ESTEEM approved, block "+txr.blockNumber);
  } catch (e) { log(logBox, "‚ùå "+(e.message||e)); }
};
$("fundSeller").onclick = async () => {
  const logBox = $("actionLog");
  try {
    const a = $("escrowAddr").value.trim();
    const esc = new ethers.Contract(a, ESCROW_ABI, signer);
    const tx = await esc.fundSeller(); const rc = await tx.wait();
    log(logBox, "‚úÖ Seller funded (ESTEEM), tx "+tx.hash);
    $("load").click();
  } catch (e) { log(logBox, "‚ùå "+(e.message||e)); }
};

$("checkAllowBuyer").onclick = async () => {
  const logBox = $("actionLog");
  try {
    if (!signer) throw new Error("Connect wallet");
    $("load").click();
    const owner = await signer.getAddress();
    const spender = $("escrowAddr").value.trim();
    const a = await checkAllowance(WPLS_ADDR, owner, spender);
    log(logBox, `Buyer allowance WPLS‚ÜíEscrow: ${a.toString()}`);
  } catch (e) { log(logBox, "‚ùå "+(e.message||e)); }
};
$("approveBuyer").onclick = async () => {
  const logBox = $("actionLog");
  try {
    if (!signer) throw new Error("Connect wallet"); $("load").click();
    const sum = JSON.parse($("summary").textContent);
    const txr = await approveTo(WPLS_ADDR, $("escrowAddr").value.trim(), BigInt(sum.amountBuyWei));
    log(logBox, "‚úÖ WPLS approved, block "+txr.blockNumber);
  } catch (e) { log(logBox, "‚ùå "+(e.message||e)); }
};
$("fundBuyer").onclick = async () => {
  const logBox = $("actionLog");
  try {
    const a = $("escrowAddr").value.trim();
    const esc = new ethers.Contract(a, ESCROW_ABI, signer);
    const tx = await esc.fundBuyer(); const rc = await tx.wait();
    log(logBox, "‚úÖ Buyer funded (WPLS), tx "+tx.hash);
    $("load").click();
  } catch (e) { log(logBox, "‚ùå "+(e.message||e)); }
};

/*** ====== SETTLE / REFUND ====== ***/
async function act(fn){
  const logBox = $("actionLog");
  try {
    const a = $("escrowAddr").value.trim();
    const esc = new ethers.Contract(a, ESCROW_ABI, signer);
    const tx = await esc[fn](); const rc = await tx.wait();
    log(logBox, `‚úÖ ${fn} confirmed, tx ${tx.hash}`);
    $("load").click();
  } catch (e) { log(logBox, "‚ùå "+(e.message||e)); }
}
$("settle").onclick = () => act("settle");
$("refund").onclick = () => act("refund");
</script>
</body>
</html>



