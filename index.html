<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trustless Atomic Swap ‚Äì PulseChain (369)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ‚úÖ load ethers first -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 900px; margin: 28px auto; padding: 0 14px; }
  h2 { margin-top: 0; }
  fieldset { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-bottom: 18px; }
  label { display:block; margin-top:8px; }
  input { width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:8px; }
  small { color:#666; }
  button { margin-top:10px; padding:10px 14px; border:0; border-radius:10px; background:#222; color:white; cursor:pointer; }
  button:disabled { opacity:0.5; cursor:not-allowed; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  #log { background:#f8f8f8; padding:12px; border-radius:10px; white-space:pre-wrap; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .ok { color: #128a23; }
  .warn { color: #a05a00; }
  .err { color: #b00020; }
  a { color:#0a58ca; text-decoration:none; }
</style>
</head>

<body>
<h2>Trustless Atomic Escrow ‚Äì PulseChain (369)</h2>
<p>Factory-spawned, per-trade escrow with deterministic addresses (CREATE2).  
No owner. No upgrades. Fully atomic swap.</p>

<button id="connectBtn">1) Connect Wallet</button>
<button id="switchBtn">2) Switch to PulseChain</button>

<fieldset>
  <legend><b>Create / Predict a New Escrow</b></legend>
  <div class="row">
    <div>
      <label><b>Party A ‚Äì sender of ESTEEM (Token A)</b> <input id="partyA" placeholder="0x..." /></label>
      <label>Token A (ESTEEM) address
        <input id="tokenA" />
        <small>Pre-filled ESTEEM address on PulseChain</small>
      </label>
      <label>Amount A (ESTEEM) <input id="amountA" type="number" step="any" placeholder="e.g., 100" /></label>
    </div>
    <div>
      <label><b>Party B ‚Äì sender of eDAI (Token B)</b> <input id="partyB" placeholder="0x..." /></label>
      <label>Token B (eDAI) address
        <input id="tokenB" value="0xefd766ccb38eaf1dfd701853bfce31359239f305" />
        <small>eDAI ‚Äì 18 decimals</small>
      </label>
      <label>Amount B (eDAI) <input id="amountB" type="number" step="any" placeholder="e.g., 250" /></label>
    </div>
  </div>

  <label>Deadline (minutes from now)
    <input id="deadlineMins" type="number" step="1" value="60" />
    <small>Example: 60 = 1 hour ¬∑ 1440 = 1 day</small>
  </label>

  <div class="row">
    <div>
      <label>Factory Address (deployed by you)
        <input id="factoryAddr" placeholder="0x..." />
      </label>
    </div>
    <div>
      <label>Computed Escrow Address
        <input id="predicted" class="mono" readonly />
      </label>
    </div>
  </div>

  <button id="predictBtn">Predict Escrow Address</button>
  <button id="deployBtn">Deploy Escrow</button>
  <div id="preview"></div>
</fieldset>

<fieldset>
  <legend><b>Interact with an Existing Escrow</b></legend>
  <label>Escrow Address <input id="escrowAddr" placeholder="0x..." /></label>
  <div class="row">
    <button id="readAllBtn">Read Parameters & Status</button>
    <button id="statusBtn">Refresh Status</button>
  </div>

  <div class="row">
    <div>
      <button id="approveA">Approve A (ESTEEM)</button>
      <button id="depositA">Deposit A (ESTEEM)</button>
    </div>
    <div>
      <button id="approveB">Approve B (eDAI)</button>
      <button id="depositB">Deposit B (eDAI)</button>
    </div>
  </div>

  <div class="row">
    <div><button id="settleBtn">Settle (Atomic Swap)</button></div>
    <div><button id="refundBtn">Refund (after deadline)</button></div>
  </div>

  <div id="links"></div>
</fieldset>

<fieldset>
  <legend><b>Log</b></legend>
  <div id="log"></div>
</fieldset>

<script>
/* ---------- CONFIG (put your values) ---------- */
const DEFAULT_FACTORY = "0x571594b57fa8E8c2Cd426ABe4D91D2d594755a90";      // üëà your deployed factory
const ESTEEM_ADDR     = "0x9FDCe721c528e6dbc4f494F3E80B9b28a3059aB5";  // üëà ESTEEM token on PulseChain
const PLS_CHAIN_ID_HEX = "0x171"; // 369
const PLS_RPC = "https://rpc.pulsechain.com";
const PLS_EXPLORER = "https://explorer.pulsechain.com";
const SOURCIFY_BASE = "https://repo.sourcify.dev/369";

/* ---------- ABIs ---------- */
const FACTORY_ABI = [
  "event SwapCreated(address indexed escrow, address indexed partyA, address indexed partyB)",
  "function predictAddress(address,address,address,address,uint256,uint256,uint256) view returns (address)",
  "function createSwap(address,address,address,address,uint256,uint256,uint256) returns (address)"
];
const ESCROW_ABI = [
  "function partyA() view returns (address)",
  "function partyB() view returns (address)",
  "function tokenA() view returns (address)",
  "function tokenB() view returns (address)",
  "function amountA() view returns (uint256)",
  "function amountB() view returns (uint256)",
  "function deadline() view returns (uint256)",
  "function depositedA() view returns (bool)",
  "function depositedB() view returns (bool)",
  "function status() view returns (bool,bool,uint256,bool)",
  "function depositA()",
  "function depositB()",
  "function settle()",
  "function refund()"
];
const ERC20_ABI = [
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 value) returns (bool)"
];

/* ---------- GLOBALS ---------- */
let provider, signer;
function $(id){ return document.getElementById(id); }
function log(msg, cls){ $("log").innerHTML = `<div class="${cls||""}">${msg}</div>\n` + $("log").innerHTML; }
function a(href,text){ return `<a href="${href}" target="_blank">${text}</a>`; }

/* ---------- CONNECT / SWITCH ---------- */
async function connect(){
  try{
    if(!window.ethereum){ log("‚ùå No wallet found. Install MetaMask.", "err"); return; }
    const accounts = await window.ethereum.request({method:"eth_requestAccounts"});
    if(!accounts?.length){ log("Connection cancelled.", "warn"); return; }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    log(`‚úÖ Connected wallet: ${await signer.getAddress()}`, "ok");
  }catch(e){ log(`Connection error: ${e.message}`, "err"); }
}
async function switchToPulse(){
  try{
    await ethereum.request({method:"wallet_switchEthereumChain", params:[{chainId:PLS_CHAIN_ID_HEX}]});
    log("‚úÖ Switched to PulseChain", "ok");
  }catch(e){
    if(e.code===4902){
      await ethereum.request({
        method:"wallet_addEthereumChain",
        params:[{chainId:PLS_CHAIN_ID_HEX, chainName:"PulseChain", rpcUrls:[PLS_RPC],
          nativeCurrency:{name:"PLS",symbol:"PLS",decimals:18}, blockExplorerUrls:[PLS_EXPLORER]}]
      });
      log("PulseChain added. Try switching again.", "ok");
    }else log(`Switch error: ${e.message}`, "err");
  }
}

/* ---------- HELPERS ---------- */
async function getTokenMeta(addr){
  const c = new ethers.Contract(addr, ERC20_ABI, provider||signer);
  let symbol = addr.slice(0,6)+"‚Ä¶"+addr.slice(-4);
  let decimals = 18;
  try{ symbol = await c.symbol(); }catch{}
  try{ decimals = await c.decimals(); }catch{}
  return {symbol,decimals,contract:c};
}
function getFactoryAddr(){ return $("factoryAddr").value.trim() || DEFAULT_FACTORY; }
function fmtUnits(v,d){ try{return ethers.formatUnits(v,d);}catch{return v.toString();} }

/* ---------- CORE ---------- */
async function gather(){
  const tokenA = $("tokenA").value.trim();
  const tokenB = $("tokenB").value.trim();
  const partyA = $("partyA").value.trim();
  const partyB = $("partyB").value.trim();
  const amountA = $("amountA").value || "0";
  const amountB = $("amountB").value || "0";
  const mins = parseInt($("deadlineMins").value,10)||60;
  const deadline = Math.floor(Date.now()/1000)+(mins*60);
  const metaA = await getTokenMeta(tokenA);
  const metaB = await getTokenMeta(tokenB);
  return {
    tokenA,tokenB,partyA,partyB,
    amountAWei:ethers.parseUnits(amountA,metaA.decimals),
    amountBWei:ethers.parseUnits(amountB,metaB.decimals),
    deadline,metaA,metaB
  };
}

async function predictAddress(){
  try{
    const f = getFactoryAddr();
    const fac = new ethers.Contract(f, FACTORY_ABI, provider||signer);
    const p = await gather();
    const predicted = await fac.predictAddress(p.partyA,p.partyB,p.tokenA,p.tokenB,p.amountAWei,p.amountBWei,p.deadline);
    $("predicted").value = predicted;
    $("preview").innerHTML =
      `<p><b>Immutable terms</b></p>
       <ul class="mono">
       <li>Party A: ${p.partyA}</li>
       <li>Party B: ${p.partyB}</li>
       <li>Token A (ESTEEM): ${p.tokenA}</li>
       <li>Amount A: ${fmtUnits(p.amountAWei,p.metaA.decimals)} ${p.metaA.symbol}</li>
       <li>Token B (eDAI): ${p.tokenB}</li>
       <li>Amount B: ${fmtUnits(p.amountBWei,p.metaB.decimals)} ${p.metaB.symbol}</li>
       <li>Deadline: ${new Date(p.deadline*1000).toLocaleString()}</li>
       </ul>
       <p>Predicted Escrow: <code class="mono">${predicted}</code><br>
       ${a(`${PLS_EXPLORER}/address/${predicted}`,"View on Explorer")}</p>`;
    log("‚úÖ Predicted address computed.", "ok");
  }catch(e){ log(`Predict error: ${e.message}`,"err"); }
}

async function deployEscrow(){
  try{
    if(!signer) await connect();
    const f = getFactoryAddr();
    const fac = new ethers.Contract(f, FACTORY_ABI, signer);
    const p = await gather();
    const tx = await fac.createSwap(p.partyA,p.partyB,p.tokenA,p.tokenB,p.amountAWei,p.amountBWei,p.deadline);
    log(`Tx sent: ${tx.hash}`,"warn");
    const rcpt = await tx.wait();
    const iface = new ethers.Interface(FACTORY_ABI);
    let escrow = $("predicted").value;
    for(const lg of rcpt.logs){
      try{const parsed=iface.parseLog(lg);if(parsed?.name==="SwapCreated")escrow=parsed.args.escrow;}catch{}
    }
    $("escrowAddr").value=escrow;
    $("links").innerHTML=
      `<p>${a(`${PLS_EXPLORER}/address/${escrow}`,"Escrow on Explorer")} |
       ${a(`${SOURCIFY_BASE}/${f}/`,"Verify Factory on Sourcify")}</p>`;
    log(`‚úÖ Deployed Escrow at ${escrow}`,"ok");
  }catch(e){ log(`Deploy error: ${e.message}`,"err"); }
}

/* ---------- EVENT WIRING ---------- */
window.addEventListener("DOMContentLoaded",()=>{
  if(DEFAULT_FACTORY) $("factoryAddr").value=DEFAULT_FACTORY;
  if(ESTEEM_ADDR) $("tokenA").value=ESTEEM_ADDR;

  $("connectBtn").onclick=connect;
  $("switchBtn").onclick=switchToPulse;
  $("predictBtn").onclick=predictAddress;
  $("deployBtn").onclick=deployEscrow;
});
</script>
</body>
</html>
