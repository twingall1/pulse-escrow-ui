<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulsecrow ‚Äì Trustless Two-Party Escrow on PulseChain</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<style>
:root { --primary:#0084ff; --bg:#f8fafc; --text:#222; }
html { scroll-behavior: smooth; }
body {
  font-family:"Segoe UI",Roboto,sans-serif;
  background:var(--bg); color:var(--text);
  max-width:640px; margin:40px auto; padding:24px;
  border-radius:16px; box-shadow:0 0 20px rgba(0,0,0,0.08);
}
h1,h2{text-align:center;}
input,button {
  width:100%; padding:10px; margin:6px 0;
  border-radius:8px; border:1px solid #ccc; font-size:15px;
}
button {
  background:var(--primary); color:#fff; font-weight:600;
  border:none; cursor:pointer;
}
button:disabled{background:#ccc;cursor:not-allowed;}
button:hover:enabled{background:#006edc;}
#statusBox {
  background:#fff; border:1px solid #ddd; border-radius:8px;
  padding:10px; margin-top:10px; white-space:pre-wrap;
}
.small{font-size:0.9em;color:#555;}
.section{margin-top:30px;}
.esteem-toggle {
  display:flex; align-items:center; gap:6px;
  margin:4px 0 10px 0; font-size:0.9em; width:fit-content;
}
.esteem-toggle input[type="checkbox"] {
  accent-color: var(--primary);
  transform: scale(1.2);
  cursor:pointer;
}
.esteem-toggle label { cursor:pointer; }
.logo-row {
  display:flex; justify-content:center; align-items:center;
  gap:16px; margin-bottom:10px;
}
.crow { font-size:60px; line-height:1; }
#loadingOverlay {
  position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(255,255,255,0.85);
  display:none; align-items:center; justify-content:center;
  flex-direction:column; font-size:1.2em; color:#333; z-index:999999;
}
.spinner {
  border:4px solid #ccc;
  border-top:4px solid var(--primary);
  border-radius:50%;
  width:42px; height:42px;
  animation:spin 1s linear infinite;
  margin-bottom:12px;
}
@keyframes spin {100% {transform:rotate(360deg);}}
#verifyBadge { margin-top:6px; font-size:13px; text-align:center; }
#instructions {
  background:#fff; border:1px solid #ddd; border-radius:10px;
  padding:16px; margin-top:40px; font-size:14px; line-height:1.55;
}
</style>
</head>

<body>
<div class="logo-row">
  <span style="font-size:36px;">‚ö°</span>
  <span class="crow">üê¶‚Äç‚¨õ</span>
  <span style="font-size:36px;">‚ö°</span>
</div>
<h1>Pulsecrow</h1>
<p style="text-align:center;">
  Simple two-deposit escrow on <b>PulseChain</b><br>
  <a href="#instructions" style="font-size:14px;color:#0084ff;text-decoration:none;">üìò View Instructions</a>
</p>

<button id="connectBtn">üîó Connect Wallet</button>
<div id="walletInfo" class="small"></div>
<p class="small" style="text-align:center;">
  Pulsecrow runs entirely on-chain using verified contracts.<br>
  Funds are never held by Pulsecrow ‚Äî only by the blockchain escrow itself.
</p>
<hr/>

<div class="section">
  <h2>Create New Escrow</h2>
  <input id="partyB" placeholder="Counterparty address (Party B)" />
  <input id="tokenA" placeholder="Your token (Token A) address" />
  <div class="esteem-toggle"><input type="checkbox" id="useEsteemA"><label for="useEsteemA">Use Esteem for Token A</label></div>
  <div class="esteem-toggle"><input type="checkbox" id="usePLSA"><label for="usePLSA">Use PLS for Token A</label></div>
  <input id="amountA" placeholder="Your amount (e.g. 1.5)" />
  <input id="decA" placeholder="Token A decimals (e.g. 18)" />
  <input id="tokenB" placeholder="Their token (Token B) address" />
  <div class="esteem-toggle"><input type="checkbox" id="useEsteemB"><label for="useEsteemB">Use Esteem for Token B</label></div>
  <div class="esteem-toggle"><input type="checkbox" id="usePLSB"><label for="usePLSB">Use PLS for Token B</label></div>
  <input id="amountB" placeholder="Their amount (e.g. 100)" />
  <input id="decB" placeholder="Token B decimals (e.g. 18)" />
  <input id="deadline" placeholder="Deadline (minutes from now)" />
  <button id="createBtn" disabled>Create Escrow</button>
  <div id="newEscrow" class="small"></div>
</div>

<div class="section">
  <h2>Join Existing Escrow</h2>
  <input id="escrowAddr" placeholder="Paste Escrow Address" />
  <div id="verifyBadge">Waiting for details...</div>
  <button id="approveBtn" disabled>Approve My Token</button>
  <button id="depositBtn" disabled>Deposit My Token</button>
  <button id="settleBtn" disabled>Settle</button>
  <button id="refundBtn" disabled>Refund</button>
  <div id="statusBox">Status: not connected</div>
</div>

<div id="loadingOverlay">
  <div class="spinner"></div>
  <div>‚è≥ Waiting for confirmation...</div>
</div>

<div id="instructions">
  <b>How to use Pulsecrow:</b><br><br>
  1Ô∏è‚É£ Connect your wallet (e.g. OKX or MetaMask).<br>
  2Ô∏è‚É£ Choose to create or join an escrow.<br>
  3Ô∏è‚É£ Both users must input identical token info before deposits are enabled.<br>
  4Ô∏è‚É£ Native PLS cannot be used directly ‚Äî wrap to WPLS if needed.<br><br>
  <p style="font-size:13px;text-align:center;">
    üîç Official verified Pulsecrow factory contract:<br>
    <a href="https://scan.pulsechain.com/address/0x6a8359FB0204C5A5a52b7ecf3bbb76299DE16EfF" target="_blank" style="color:#0084ff;">0x6a8359FB0204C5A5a52b7ecf3bbb76299DE16EfF</a>
  </p>
</div>

<script>
const FACTORY="0x6a8359FB0204C5A5a52b7ecf3bbb76299DE16EfF";
const ESTEEM_TOKEN="0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5";
const ESTEEM_DECIMALS=18;
const factoryABI=[
 "function createEscrow(address,address,address,address,uint256,uint256,uint256) external returns (address)",
 "event EscrowCreated(address indexed creator,address escrowAddress)"
];
const escrowABI=[
 "function depositA() external","function depositB() external","function settle() external",
 "function refundA() external","function refundB() external",
 "function partyA() view returns(address)","function partyB() view returns(address)",
 "function tokenA() view returns(address)","function tokenB() view returns(address)",
 "function amountA() view returns(uint256)","function amountB() view returns(uint256)",
 "function depositedA() view returns(bool)","function depositedB() view returns(bool)"
];
let provider,signer,userAddr;

function showLoading(b){document.getElementById("loadingOverlay").style.display=b?"flex":"none";}
function toWei(a,d){return BigInt(Math.round(parseFloat(a)*10**d));}

async function connect(){
 try{
   if(!window.ethereum)return alert("Please install MetaMask or OKX Wallet.");
   provider=new ethers.BrowserProvider(window.ethereum);
   await provider.send("eth_requestAccounts",[]);
   signer=await provider.getSigner(); userAddr=await signer.getAddress();
   document.getElementById("walletInfo").innerText=`Connected: ${userAddr}`;
   ["createBtn","settleBtn","refundBtn"].forEach(id=>document.getElementById(id).disabled=false);
   document.getElementById("statusBox").innerText="Wallet connected.";
 }catch(e){alert("Connection failed: "+e.message);}
}

async function createEscrow(){
 try{
  showLoading(true);
  const f=new ethers.Contract(FACTORY,factoryABI,signer);
  const amtA=toWei(document.getElementById("amountA").value,parseInt(document.getElementById("decA").value));
  const amtB=toWei(document.getElementById("amountB").value,parseInt(document.getElementById("decB").value));
  const minutes=parseInt(document.getElementById("deadline").value);
  const deadlineUnix=Math.floor(Date.now()/1000)+(minutes*60);
  const tx=await f.createEscrow(userAddr,document.getElementById("partyB").value,document.getElementById("tokenA").value,document.getElementById("tokenB").value,amtA,amtB,deadlineUnix);
  const rcpt=await tx.wait();
  const evt=rcpt.logs?.find(l=>l.fragment?.name==="EscrowCreated");
  const addr=evt?evt.args.escrowAddress:"(unknown)";
  const shareLink=`${window.location.origin}${window.location.pathname}?escrow=${addr}`;
  document.getElementById("newEscrow").innerHTML=`‚úÖ Escrow created at:<br><code>${addr}</code><br>Share:<br><a href="${shareLink}" target="_blank">${shareLink}</a>`;
  document.getElementById("escrowAddr").value=addr;
 }catch(e){console.log(e);alert(e.message);}finally{showLoading(false);}
}

function getEscrow(){
 const addr=document.getElementById("escrowAddr").value.trim();
 if(!ethers.isAddress(addr))throw new Error("Invalid address");
 return new ethers.Contract(addr,escrowABI,signer);
}

async function approve(){
 try{
  showLoading(true);
  const e=getEscrow(); const [a,b]=await Promise.all([e.partyA(),e.partyB()]);
  const isA=userAddr.toLowerCase()===a.toLowerCase();
  const tokenAddr=isA?await e.tokenA():await e.tokenB();
  const amt=isA?await e.amountA():await e.amountB();
  const token=new ethers.Contract(tokenAddr,["function approve(address,uint256)public returns(bool)"],signer);
  const tx=await token.approve(document.getElementById("escrowAddr").value,amt);
  await tx.wait(); alert("‚úÖ Approved!");
 }catch(e){alert("Approval error: "+e.message);}finally{showLoading(false);}
}

async function deposit(){
 try{
  showLoading(true);
  const e=getEscrow(); const [a,b]=await Promise.all([e.partyA(),e.partyB()]);
  const isA=userAddr.toLowerCase()===a.toLowerCase();
  const tx=await(isA?e.depositA():e.depositB());
  await tx.wait(); alert("‚úÖ Deposit complete.");
 }catch(e){alert("Deposit error: "+e.message);}finally{showLoading(false);}
}

// --- Escrow match verifier for User B ---
async function verifyEscrowMatch(){
 const escrowAddr=document.getElementById("escrowAddr").value.trim();
 if(!ethers.isAddress(escrowAddr))return;
 try{
  const e=new ethers.Contract(escrowAddr,escrowABI,provider);
  const [tA,tB,aA,aB]=await Promise.all([e.tokenA(),e.tokenB(),e.amountA(),e.amountB()]);
  const iA=document.getElementById("tokenA").value.trim().toLowerCase();
  const iB=document.getElementById("tokenB").value.trim().toLowerCase();
  const decA=parseInt(document.getElementById("decA").value||18);
  const decB=parseInt(document.getElementById("decB").value||18);
  const amtA=parseFloat(document.getElementById("amountA").value||0);
  const amtB=parseFloat(document.getElementById("amountB").value||0);
  const pA=BigInt(Math.round(amtA*10**decA));
  const pB=BigInt(Math.round(amtB*10**decB));
  const match=(iA===tA.toLowerCase()&&iB===tB.toLowerCase()&&pA===aA&&pB===aB);
  const ab=document.getElementById("approveBtn"), db=document.getElementById("depositBtn");
  if(match){ab.disabled=false;db.disabled=false;document.getElementById("verifyBadge").innerText="‚úÖ Escrow details match.";}
  else{ab.disabled=true;db.disabled=true;document.getElementById("verifyBadge").innerText="‚ùå Escrow details don‚Äôt match.";}
 }catch(err){document.getElementById("verifyBadge").innerText="‚ö†Ô∏è Cannot read escrow";}
}
["tokenA","tokenB","amountA","amountB","decA","decB","escrowAddr"].forEach(id=>{
 const el=document.getElementById(id);
 if(el)el.addEventListener("input",verifyEscrowMatch);
});

function setupToggles(){
 const cbA=document.getElementById("useEsteemA"), cbB=document.getElementById("useEsteemB"),
       cbPA=document.getElementById("usePLSA"), cbPB=document.getElementById("usePLSB"),
       tA=document.getElementById("tokenA"), tB=document.getElementById("tokenB"),
       dA=document.getElementById("decA"), dB=document.getElementById("decB");
 cbA.onchange=()=>{if(cbA.checked){cbPA.checked=false;tA.value=ESTEEM_TOKEN;dA.value=ESTEEM_DECIMALS;tA.disabled=dA.disabled=true;}else{tA.disabled=dA.disabled=false;tA.value="";dA.value="";}};
 cbB.onchange=()=>{if(cbB.checked){cbPB.checked=false;tB.value=ESTEEM_TOKEN;dB.value=ESTEEM_DECIMALS;tB.disabled=dB.disabled=true;}else{tB.disabled=dB.disabled=false;tB.value="";dB.value="";}};
 cbPA.onchange=()=>{if(cbPA.checked){cbA.checked=false;tA.value="PLS";dA.value=18;tA.disabled=dA.disabled=true;}else{tA.disabled=dA.disabled=false;tA.value="";dA.value="";}};
 cbPB.onchange=()=>{if(cbPB.checked){cbB.checked=false;tB.value="PLS";dB.value=18;tB.disabled=dB.disabled=true;}else{tB.disabled=dB.disabled=false;tB.value="";dB.value="";}};
}
setupToggles();

document.getElementById("connectBtn").onclick=connect;
document.getElementById("createBtn").onclick=createEscrow;
document.getElementById("approveBtn").onclick=approve;
document.getElementById("depositBtn").onclick=deposit;
</script>
</body>
</html>
