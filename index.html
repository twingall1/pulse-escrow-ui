<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pulsecrow ‚Äì Trustless Two-Party Escrow on PulseChain</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <style>
    :root { --primary:#0084ff; --bg:#f8fafc; --text:#222; }
    html { scroll-behavior: smooth; }
    body {
      font-family:"Segoe UI",Roboto,sans-serif;
      background:var(--bg); color:var(--text);
      max-width:640px; margin:40px auto; padding:24px;
      border-radius:16px; box-shadow:0 0 20px rgba(0,0,0,0.08);
    }
    h1,h2{text-align:center;}
    input,button {
      width:100%; padding:10px; margin:6px 0;
      border-radius:8px; border:1px solid #ccc; font-size:15px;
    }
    button {
      background:var(--primary); color:#fff; font-weight:600;
      border:none; cursor:pointer;
    }
    button:disabled{background:#ccc;cursor:not-allowed;}
    button:hover:enabled{background:#006edc;}
    #statusBox {
      background:#fff; border:1px solid #ddd; border-radius:8px;
      padding:10px; margin-top:10px; white-space:pre-wrap;
    }
    .small{font-size:0.9em;color:#555;}
    .section{margin-top:30px;}
    .toggle-row {
      display:flex; flex-wrap:wrap; gap:12px;
      justify-content:flex-start; align-items:center;
      margin:6px 0 10px 0;
    }
    .toggle {
      display:flex; align-items:center; gap:6px;
      font-size:0.9em;
    }
    .toggle input[type="checkbox"] {
      accent-color: var(--primary);
      transform: scale(1.2);
      cursor:pointer;
    }
    .logo-row {
      display:flex; justify-content:center; align-items:center;
      gap:16px; margin-bottom:10px;
    }
    .crow { font-size:60px; line-height:1; }
    #loadingOverlay {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(255,255,255,0.85);
      display:none; align-items:center; justify-content:center;
      flex-direction:column; font-size:1.2em; color:#333; z-index:999999;
    }
    .spinner {
      border:4px solid #ccc;
      border-top:4px solid var(--primary);
      border-radius:50%;
      width:42px; height:42px;
      animation:spin 1s linear infinite;
      margin-bottom:12px;
    }
    @keyframes spin {100% {transform:rotate(360deg);} }
    #instructions {
      background:#fff; border:1px solid #ddd; border-radius:10px;
      padding:16px; margin-top:40px; font-size:14px; line-height:1.55;
    }
  </style>
</head>

<body>
  <div class="logo-row">
    <span style="font-size:36px;">‚ö°</span>
    <span class="crow">üê¶‚Äç‚¨õ</span>
    <span style="font-size:36px;">‚ö°</span>
  </div>
  <h1 style="margin-top:0;">Pulsecrow</h1>
  <p style="text-align:center;">
    Trustless two-deposit escrow on <b>PulseChain</b><br>
    <a href="#instructions" style="font-size:14px;color:#0084ff;text-decoration:none;">
      üìò View Instructions
    </a>
  </p>

  <button id="connectBtn">üîó Connect Wallet</button>
  <div id="walletInfo" class="small"></div>
  <hr/>

  <div class="section">
    <h2>Create New Escrow</h2>
    <input id="partyB" placeholder="Counterparty address (Party B)" />
    <input id="tokenA" placeholder="Your token (Token A) address" />
    <div class="toggle-row">
      <div class="toggle"><input type="checkbox" id="useEsteemA"><label for="useEsteemA">Use Esteem for Token A</label></div>
      <div class="toggle"><input type="checkbox" id="usePLSA"><label for="usePLSA">Use PLS for Token A</label></div>
    </div>
    <input id="amountA" placeholder="Your amount (e.g. 1.5)" />
    <input id="decA" placeholder="Token A decimals (e.g. 18)" />

    <input id="tokenB" placeholder="Their token (Token B) address" />
    <div class="toggle-row">
      <div class="toggle"><input type="checkbox" id="useEsteemB"><label for="useEsteemB">Use Esteem for Token B</label></div>
      <div class="toggle"><input type="checkbox" id="usePLSB"><label for="usePLSB">Use PLS for Token B</label></div>
    </div>
    <input id="amountB" placeholder="Their amount (e.g. 100)" />
    <input id="decB" placeholder="Token B decimals (e.g. 18)" />
    <input id="deadline" placeholder="Deadline (minutes from now)" />

    <button id="createBtn" disabled>Create Escrow</button>
    <div id="newEscrow" class="small"></div>
  </div>

  <div class="section">
    <h2>Join Existing Escrow</h2>
    <input id="escrowAddr" placeholder="Paste Escrow Address" />
    <button id="approveBtn" disabled>Approve My Token</button>
    <button id="depositBtn" disabled>Deposit My Token</button>
    <button id="settleBtn" disabled>Settle</button>
    <button id="refundBtn" disabled>Refund</button>
    <div id="statusBox">Status: not connected</div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div>‚è≥ Waiting for confirmation...</div>
  </div>

  <div id="instructions">
    <b>How to use Pulsecrow:</b><br><br>
    1Ô∏è‚É£ Click <b>‚ÄúConnect Wallet‚Äù</b> and choose your PulseChain wallet (e.g. MetaMask or OKX).<br>
    2Ô∏è‚É£ To create a new escrow, fill in the token addresses, amounts, and deadline.<br>
    3Ô∏è‚É£ Toggle ‚ÄúUse Esteem‚Äù or ‚ÄúUse PLS‚Äù to autofill known safe tokens.<br>
    4Ô∏è‚É£ Click <b>Create Escrow</b>, then share the escrow link with your counterparty.<br>
    5Ô∏è‚É£ To join an escrow, paste the address, approve your token, then deposit.<br>
    6Ô∏è‚É£ Once both sides deposit, click <b>Settle</b>. If the deadline passes, either party can <b>Refund</b>.<br><br>
    ‚ö†Ô∏è Native PLS cannot be used directly ‚Äî wrap it into WPLS if needed.<br><br>
    üîç <b>Official verified Pulsecrow factory contract:</b><br>
    <a href="https://scan.pulsechain.com/address/0xDf370c23b14E694117C930a46656e0750b08c301"
       target="_blank" rel="noopener noreferrer"
       style="color:#0084ff;word-break:break-all;">
       0xDf370c23b14E694117C930a46656e0750b08c301
    </a>
  </div>

  <script>
    const FACTORY = "0xDf370c23b14E694117C930a46656e0750b08c301";
    const ESTEEM_TOKEN = "0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5";
    const WPLS_TOKEN = "0xa10d38c309b7b86a0e0f34218c5a620b6245ff96";
    const ESTEEM_DECIMALS = 18;
    const PLS_DECIMALS = 18;

    const factoryABI = [
      "function createEscrow(address,address,address,address,uint256,uint256,uint256) external returns (address)",
      "event EscrowCreated(address indexed creator,address escrowAddress)"
    ];
    const escrowABI = [
      "function depositA() external","function depositB() external",
      "function settle() external","function refundA() external","function refundB() external",
      "function partyA() view returns (address)","function partyB() view returns (address)",
      "function tokenA() view returns (address)","function tokenB() view returns (address)",
      "function amountA() view returns (uint256)","function amountB() view returns (uint256)",
      "function depositedA() view returns (bool)","function depositedB() view returns (bool)"
    ];

    let provider, signer, userAddr;
    const showLoading = show => document.getElementById("loadingOverlay").style.display = show ? "flex" : "none";
    const log = msg => console.log(msg);

    async function connect() {
      if(!window.ethereum) return alert("Install MetaMask or OKX Wallet first.");
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      userAddr = await signer.getAddress();
      document.getElementById("walletInfo").innerText = `Connected: ${userAddr}`;
      ["createBtn","approveBtn","depositBtn","settleBtn","refundBtn"].forEach(id => document.getElementById(id).disabled=false);
      document.getElementById("statusBox").innerText="Wallet connected.";
    }

    function toWei(amount,dec){return BigInt(Math.round(parseFloat(amount)*10**dec));}

    async function createEscrow(){
      try {
        showLoading(true);
        const f = new ethers.Contract(FACTORY, factoryABI, signer);
        const amtA = toWei(document.getElementById("amountA").value, parseInt(document.getElementById("decA").value));
        const amtB = toWei(document.getElementById("amountB").value, parseInt(document.getElementById("decB").value));
        const minutes = parseInt(document.getElementById("deadline").value);
        const deadlineUnix = Math.floor(Date.now()/1000)+(minutes*60);
        const tx = await f.createEscrow(
          userAddr,
          document.getElementById("partyB").value,
          document.getElementById("tokenA").value,
          document.getElementById("tokenB").value,
          amtA, amtB, deadlineUnix
        );
        const rcpt = await tx.wait();
        const evt = rcpt.logs?.find(l=>l.fragment?.name==="EscrowCreated");
        const addr = evt?evt.args.escrowAddress:"(unknown)";
        const shareLink=`${window.location.origin}${window.location.pathname}?escrow=${addr}`;
        document.getElementById("newEscrow").innerHTML=`‚úÖ Escrow created:<br><code>${addr}</code><br><a href="${shareLink}" target="_blank">${shareLink}</a>`;
        document.getElementById("escrowAddr").value=addr;
      } catch(e){alert("Error: "+e.message);} finally {showLoading(false);}
    }

    const getEscrow=()=>new ethers.Contract(document.getElementById("escrowAddr").value,escrowABI,signer);

    async function approve(){
      try {
        showLoading(true);
        const e=getEscrow();const a=await e.partyA(),b=await e.partyB();
        const isA=userAddr.toLowerCase()===a.toLowerCase();
        const tokenAddr=isA?await e.tokenA():await e.tokenB();
        const amt=isA?await e.amountA():await e.amountB();
        const token=new ethers.Contract(tokenAddr,["function approve(address,uint256) public returns(bool)"],signer);
        const tx=await token.approve(document.getElementById("escrowAddr").value,amt);
        await tx.wait();alert("Approved!");
      }catch(e){alert("Approval error: "+e.message);}finally{showLoading(false);}
    }

    async function deposit(){
      try {
        showLoading(true);
        const e=getEscrow();const a=await e.partyA(),b=await e.partyB();
        const isA=userAddr.toLowerCase()===a.toLowerCase();
        const tx=await(isA?e.depositA():e.depositB());
        await tx.wait();alert("Deposit complete!");
      }catch(e){alert("Deposit error: "+e.message);}finally{showLoading(false);}
    }

    async function settle(){
      try{showLoading(true);const tx=await getEscrow().settle();await tx.wait();alert("Escrow settled!");}
      catch(e){alert("Settle error: "+e.message);}finally{showLoading(false);}
    }

    async function refund(){
      try{
        showLoading(true);
        const e=getEscrow();const a=await e.partyA(),b=await e.partyB();
        const isA=userAddr.toLowerCase()===a.toLowerCase();
        const tx=await(isA?e.refundA():e.refundB());
        await tx.wait();alert("Refund complete!");
      }catch(e){alert("Refund error: "+e.message);}finally{showLoading(false);}
    }

    function setupToggles(){
      const esteemToggles=[["useEsteemA","tokenA","decA"],["useEsteemB","tokenB","decB"]];
      esteemToggles.forEach(([cbId,tId,dId])=>{
        const cb=document.getElementById(cbId),t=document.getElementById(tId),d=document.getElementById(dId);
        cb.addEventListener("change",()=>{
          if(cb.checked){t.value=ESTEEM_TOKEN;d.value=ESTEEM_DECIMALS;t.disabled=d.disabled=true;}
          else{t.disabled=d.disabled=false;t.value="";d.value="";}
        });
      });
      const plsToggles=[["usePLSA","tokenA","decA"],["usePLSB","tokenB","decB"]];
      plsToggles.forEach(([cbId,tId,dId])=>{
        const cb=document.getElementById(cbId),t=document.getElementById(tId),d=document.getElementById(dId);
        cb.addEventListener("change",()=>{
          if(cb.checked){t.value=WPLS_TOKEN;d.value=PLS_DECIMALS;t.disabled=d.disabled=true;}
          else{t.disabled=d.disabled=false;t.value="";d.value="";}
        });
      });
    }

    document.getElementById("connectBtn").onclick=connect;
    document.getElementById("createBtn").onclick=createEscrow;
    document.getElementById("approveBtn").onclick=approve;
    document.getElementById("depositBtn").onclick=deposit;
    document.getElementById("settleBtn").onclick=settle;
    document.getElementById("refundBtn").onclick=refund;
    setupToggles();
  </script>
</body>
</html>
