<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pulsecrow ‚Äì Trustless Two-Party Escrow on PulseChain</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <style>
    html{scroll-behavior:smooth;}
    body{font-family:"Segoe UI",Roboto,sans-serif;background:#f8fafc;color:#222;max-width:640px;margin:40px auto;padding:24px;border-radius:16px;box-shadow:0 0 20px rgba(0,0,0,0.08);}
    h1,h2{text-align:center;}
    input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:15px;}
    button{background:#0084ff;color:#fff;font-weight:600;border:none;cursor:pointer;}
    button:disabled{background:#ccc;cursor:not-allowed;}
    button:hover:enabled{background:#006edc;}
    .small{font-size:0.9em;color:#555;}
    .section{margin-top:30px;}
    .token-choice{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0;}
    .token-choice label{display:flex;align-items:center;gap:4px;background:#fff;border:1px solid #ccc;padding:4px 8px;border-radius:6px;cursor:pointer;}
    #statusBox{background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:10px;white-space:pre-wrap;}
    .logo-row{display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:10px;}
    .crow{font-size:60px;line-height:1;}
    #loadingOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.85);display:none;align-items:center;justify-content:center;flex-direction:column;font-size:1.2em;color:#333;z-index:999999;}
    .spinner{border:4px solid #ccc;border-top:4px solid #0084ff;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin-bottom:12px;}
    @keyframes spin{100%{transform:rotate(360deg);}}
    #instructions{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px;margin-top:40px;font-size:14px;line-height:1.55;}
  </style>
</head>

<body>
  <div class="logo-row"><span style="font-size:36px;">‚ö°</span><span class="crow">üê¶‚Äç‚¨õ</span><span style="font-size:36px;">‚ö°</span></div>
  <h1>Pulsecrow</h1>
  <p style="text-align:center;">
    Trustless two-deposit escrow on <b>PulseChain</b><br>
    <small>(Use MetaMask or OKX Wallet)</small><br>
    <a href="#instructions" style="color:#0084ff;text-decoration:none;">üìò View Instructions</a>
  </p>

  <button id="connectBtn">üîó Connect Wallet</button>
  <div id="walletInfo" class="small"></div>
  <hr>

  <div class="section">
    <h2>Create Escrow</h2>
    <input id="partyB" placeholder="Counterparty address (Party B)" />

    <h3>Token A</h3>
    <div class="token-choice" id="tokenAchoices"></div>
    <input id="tokenA" placeholder="Token A address (auto-disabled if native PLS)" />
    <input id="amountA" placeholder="Your amount (e.g. 1.5)" />
    <input id="decA" placeholder="Token A decimals (e.g. 18)" />

    <h3>Token B</h3>
    <div class="token-choice" id="tokenBchoices"></div>
    <input id="tokenB" placeholder="Token B address (auto-disabled if native PLS)" />
    <input id="amountB" placeholder="Their amount (e.g. 100)" />
    <input id="decB" placeholder="Token B decimals (e.g. 18)" />

    <input id="deadline" placeholder="Deadline (minutes from now)" />
    <button id="createBtn" disabled>Create Escrow</button>
    <div id="newEscrow" class="small"></div>
  </div>

  <div class="section">
    <h2>Join Escrow</h2>
    <input id="escrowAddr" placeholder="Paste escrow address" />
    <button id="verifyBtn">Verify Inputs vs On-Chain</button>
    <button id="approveBtn" disabled>Approve My Token</button>
    <button id="depositBtn" disabled>Deposit My Token</button>
    <button id="settleBtn" disabled>Settle</button>
    <button id="refundBtn" disabled>Refund</button>
    <div id="statusBox">Status: not connected</div>
  </div>

  <div id="loadingOverlay"><div class="spinner"></div><div>‚è≥ Waiting for confirmation‚Ä¶</div></div>

  <div id="instructions">
    <b>How to use Pulsecrow:</b><br><br>
    <b>1.</b> Connect your wallet (MetaMask or OKX).<br>
    <b>2.</b> Choose to <b>create</b> a new escrow or <b>join</b> an existing one.<br><br>
    <u>Creating an escrow:</u><br>
    ‚Ä¢ Enter Party B‚Äôs wallet address.<br>
    ‚Ä¢ Select tokens for A and B from the whitelist or use native PLS.<br>
    ‚Ä¢ Enter amounts and deadline (in minutes).<br>
    ‚Ä¢ Click <b>Create Escrow</b> and wait for confirmation.<br>
    ‚Ä¢ You‚Äôll get a link ‚Äî <b>share this link with your counterparty.</b><br><br>
    <u>Joining an escrow:</u><br>
    ‚Ä¢ Open the link or paste the escrow address.<br>
    ‚Ä¢ Input the same tokens and amounts as Party A.<br>
    ‚Ä¢ Click <b>Verify Inputs vs On-Chain</b> to confirm a match.<br>
    ‚Ä¢ Only when all details match can you <b>Approve</b> and <b>Deposit.</b><br>
    ‚Ä¢ Once both deposit, either party may <b>Settle.</b><br>
    ‚Ä¢ If the deadline expires and the other party never deposited, click <b>Refund.</b><br><br>
    ‚ö†Ô∏è <b>Native PLS</b> can be used directly (no approve step). All other tokens must be whitelisted ERC-20s.<br><br>
    <p style="text-align:center;font-size:13px;">
      üîç Official verified Pulsecrow factory contract:<br>
      <a href="https://scan.pulsechain.com/address/0xb42529b2A66FD430a872788c83b10B285886b963"
         target="_blank" style="color:#0084ff;">0xb42529b2A66FD430a872788c83b10B285886b963</a>
    </p>
  </div>

  <script>
  const FACTORY="0xb42529b2A66FD430a872788c83b10B285886b963";
  const TOKENS=[
    {name:"PLS (native)",addr:"0x0000000000000000000000000000000000000000",dec:18},
    {name:"WPLS",addr:"0xa10d38c309b7b86a0e0f34218c5a620b6245ff96",dec:18},
    {name:"PLSX",addr:"0xf6b2d434b4c65a2c26b2d60c7f7b2b3e57629193",dec:18},
    {name:"WETH",addr:"0xa722c13135930332eb3d749b2f0906559d2c5b99",dec:18},
    {name:"ESTEEM",addr:"0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5",dec:18}
  ];
  const factoryABI=[
    "function createEscrow(address,address,address,address,uint256,uint256,uint256) external returns(address)",
    "event EscrowCreated(address indexed creator,address escrowAddress)"
  ];
  const escrowABI=[
    "function partyA() view returns(address)","function partyB() view returns(address)",
    "function tokenA() view returns(address)","function tokenB() view returns(address)",
    "function amountA() view returns(uint256)","function amountB() view returns(uint256)",
    "function depositedA() view returns(bool)","function depositedB() view returns(bool)",
    "function depositA() external payable","function depositB() external payable",
    "function settle() external","function refundA() external","function refundB() external"
  ];

  let provider,signer,user;
  const toWei=(a,d)=>BigInt(Math.round(parseFloat(a)*10**d));
  const showLoad=s=>document.getElementById("loadingOverlay").style.display=s?"flex":"none";

  function buildChoices(){
    ["A","B"].forEach(side=>{
      const box=document.getElementById(`token${side}choices`);
      TOKENS.forEach(t=>{
        const el=document.createElement("label");
        el.innerHTML=`<input type="radio" name="token${side}" value="${t.addr}" data-dec="${t.dec}">${t.name}`;
        el.querySelector("input").onchange=()=>{
          document.getElementById(`token${side}`).value=t.addr;
          document.getElementById(`dec${side}`).value=t.dec;
          document.getElementById(`token${side}`).disabled=(t.addr==="0x0000000000000000000000000000000000000000");
        };
        box.appendChild(el);
      });
    });
  }

  async function connect(){
    if(!window.ethereum)return alert("Install MetaMask or OKX Wallet");
    provider=new ethers.BrowserProvider(window.ethereum);
    await provider.send("eth_requestAccounts",[]);
    signer=await provider.getSigner(); user=await signer.getAddress();
    document.getElementById("walletInfo").innerText=`Connected: ${user}`;
    document.getElementById("createBtn").disabled=false;
  }

  async function createEscrow(){
    try{
      showLoad(true);
      const f=new ethers.Contract(FACTORY,factoryABI,signer);
      const amtA=toWei(document.getElementById("amountA").value,parseInt(document.getElementById("decA").value));
      const amtB=toWei(document.getElementById("amountB").value,parseInt(document.getElementById("decB").value));
      const mins=parseInt(document.getElementById("deadline").value)||30;
      const dl=Math.floor(Date.now()/1000)+mins*60;
      const tokenA=document.getElementById("tokenA").value;
      const tokenB=document.getElementById("tokenB").value;
      const tx=await f.createEscrow(user,document.getElementById("partyB").value,tokenA,tokenB,amtA,amtB,dl);
      const rc=await tx.wait();
      const ev=rc.logs?.find(l=>l.fragment?.name==="EscrowCreated");
      const addr=ev?ev.args.escrowAddress:"?";
      const link=`${location.origin}${location.pathname}?escrow=${addr}`;
      document.getElementById("newEscrow").innerHTML=`‚úÖ Escrow created at:<br><code>${addr}</code><br>üîó Share this link with your counterparty:<br><a href="${link}" target="_blank">${link}</a>`;
      document.getElementById("escrowAddr").value=addr;
    }catch(e){alert(e.message);}finally{showLoad(false);}
  }

  async function verifyUserBInputs(){
    try{
      const esc=document.getElementById("escrowAddr").value.trim();
      if(!ethers.isAddress(esc))return alert("Bad escrow address");
      const e=new ethers.Contract(esc,escrowABI,signer||provider);
      const [onA,onB,onAmtA,onAmtB]=await Promise.all([e.tokenA(),e.tokenB(),e.amountA(),e.amountB()]);
      const inA=document.getElementById("tokenA").value.trim();
      const inB=document.getElementById("tokenB").value.trim();
      const valA=parseFloat(document.getElementById("amountA").value);
      const valB=parseFloat(document.getElementById("amountB").value);
      const decA=parseInt(document.getElementById("decA").value)||18;
      const decB=parseInt(document.getElementById("decB").value)||18;
      if(isNaN(valA)||isNaN(valB)){
        document.getElementById("statusBox").innerText="‚ö†Ô∏è Enter valid numeric amounts before verifying.";return;
      }
      const amtA=toWei(valA,decA); const amtB=toWei(valB,decB);
      const match=inA.toLowerCase()===onA.toLowerCase()&&inB.toLowerCase()===onB.toLowerCase()&&amtA===onAmtA&&amtB===onAmtB;
      ["approveBtn","depositBtn","settleBtn","refundBtn"].forEach(id=>document.getElementById(id).disabled=!match);
      document.getElementById("statusBox").innerText=match?"‚úÖ Inputs match on-chain, you can proceed.":"‚ö†Ô∏è Inputs mismatch ‚Äì check tokens and amounts.";
    }catch(err){document.getElementById("statusBox").innerText="Verify error: "+err.message;}
  }

  async function approve(){try{showLoad(true);
    const e=new ethers.Contract(document.getElementById("escrowAddr").value,escrowABI,signer);
    const a=await e.partyA(),b=await e.partyB();
    const isA=user.toLowerCase()===a.toLowerCase();
    const tokenAddr=isA?await e.tokenA():await e.tokenB();
    if(tokenAddr==="0x0000000000000000000000000000000000000000")return alert("No approval needed for native PLS");
    const amt=isA?await e.amountA():await e.amountB();
    const t=new ethers.Contract(tokenAddr,["function approve(address,uint256) returns(bool)"],signer);
    const tx=await t.approve(document.getElementById("escrowAddr").value,amt);await tx.wait();
    document.getElementById("statusBox").innerText="‚úÖ Approved";
  }catch(e){alert(e.message);}finally{showLoad(false);}}

  async function deposit(){try{showLoad(true);
    const e=new ethers.Contract(document.getElementById("escrowAddr").value,escrowABI,signer);
    const a=await e.partyA(),b=await e.partyB();
    const isA=user.toLowerCase()===a.toLowerCase();
    const token=isA?await e.tokenA():await e.tokenB();
    const amt=isA?await e.amountA():await e.amountB();
    const tx=token==="0x0000000000000000000000000000000000000000"?
      await(isA?e.depositA({value:amt}):e.depositB({value:amt})):
      await(isA?e.depositA():e.depositB());
    await tx.wait();document.getElementById("statusBox").innerText="‚úÖ Deposit complete";
  }catch(e){alert(e.message);}finally{showLoad(false);}}

  async function settle(){try{showLoad(true);const e=new ethers.Contract(document.getElementById("escrowAddr").value,escrowABI,signer);await(await e.settle()).wait();document.getElementById("statusBox").innerText="‚úÖ Settled";}catch(e){alert(e.message);}finally{showLoad(false);}}
  async function refund(){try{showLoad(true);const e=new ethers.Contract(document.getElementById("escrowAddr").value,escrowABI,signer);const a=await e.partyA(),b=await e.partyB();const isA=user.toLowerCase()===a.toLowerCase();await(await(isA?e.refundA():e.refundB())).wait();document.getElementById("statusBox").innerText="‚úÖ Refunded";}catch(e){alert(e.message);}finally{showLoad(false);}}

  document.getElementById("connectBtn").onclick=connect;
  document.getElementById("createBtn").onclick=createEscrow;
  document.getElementById("verifyBtn").onclick=verifyUserBInputs;
  document.getElementById("approveBtn").onclick=approve;
  document.getElementById("depositBtn").onclick=deposit;
  document.getElementById("settleBtn").onclick=settle;
  document.getElementById("refundBtn").onclick=refund;
  buildChoices();

  // Auto-fill escrow param if opened via link
  const params=new URLSearchParams(window.location.search);
  const escrowParam=params.get("escrow");
  if(escrowParam){
    document.getElementById("escrowAddr").value=escrowParam;
    document.getElementById("statusBox").innerText="üîç Escrow loaded from link: "+escrowParam;
    window.scrollTo({top:document.querySelector("#escrowAddr").offsetTop-60,behavior:"smooth"});
  }
  </script>
</body>
</html>
