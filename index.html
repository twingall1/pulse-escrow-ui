<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Pulsecrow ‚Äì Trustless Esteem‚ÜîPLS Escrow</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      max-width: 650px;
      margin: 40px auto;
      padding: 24px;
      border-radius: 16px;
      background: #f8fafc;
      color: #222;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    h1,h2{text-align:center;}
    input,button {
      width:100%;padding:10px;margin:6px 0;
      border-radius:8px;border:1px solid #ccc;font-size:15px;
    }
    button {
      background:#0084ff;color:#fff;font-weight:600;
      border:none;cursor:pointer;
    }
    button:hover:enabled{background:#006edc;}
    button:disabled{background:#bbb;cursor:not-allowed;}
    .small{font-size:0.9em;color:#555;}
    #statusBox {
      background:#fff;border:1px solid #ddd;
      border-radius:8px;padding:10px;margin-top:10px;white-space:pre-wrap;
    }
    .spinner {
      border:4px solid #ccc;border-top:4px solid #0084ff;
      border-radius:50%;width:40px;height:40px;
      animation:spin 1s linear infinite;margin:12px auto;
    }
    @keyframes spin {100%{transform:rotate(360deg)}}
    #loadingOverlay {
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.8);
      display:none;align-items:center;justify-content:center;
      flex-direction:column;z-index:9999;
    }
    hr {margin:30px 0;}
  </style>
</head>
<body>
  <h1>‚ö° Pulsecrow Escrow ‚ö°</h1>
  <p style="text-align:center">
    <b>Trustless Esteem ‚Üî PLS escrow</b><br>
    Seller creates escrow and deposits ESTEEM.<br>
    Buyer pays PLS in one click.
  </p>

  <button id="connectBtn">üîó Connect Wallet</button>
  <div id="walletInfo" class="small"></div>
  <hr>

  <h2>Create Escrow (Seller)</h2>
  <input id="buyerAddr" placeholder="Buyer address (Party B)">
  <input id="esteemAmt" placeholder="ESTEEM amount (e.g. 100)">
  <input id="plsPrice" placeholder="Price in PLS (e.g. 10)">
  <input id="deadline" placeholder="Deadline (minutes from now)">
  <button id="createBtn" disabled>Create Escrow</button>
  <div id="newEscrow" class="small"></div>

  <hr>
  <h2>Join Escrow (Buyer)</h2>
  <input id="escrowAddr" placeholder="Paste escrow contract address">
  <button id="loadBtn" disabled>Load On-Chain Details</button>
  <div id="verifyBox" class="small"></div>
  <button id="approveBtn" disabled>Buyer: Approve PLS (if needed)</button>
  <button id="buyBtn" disabled>üí∏ Buy with PLS</button>
  <button id="refundBtn" disabled>Seller: Refund ESTEEM</button>

  <div id="statusBox">Status: not connected</div>
  <div id="log" class="small"></div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div>‚è≥ Waiting for confirmation...</div>
  </div>

  <hr>
  <p class="small">
    <b>Quick guide:</b><br>
    1Ô∏è‚É£ Esteem seller connects wallet and creates the escrow (enter buyer address, amount, price in PLS, and deadline).<br>
    2Ô∏è‚É£ After creation, share the blue link with buyer.<br>
    3Ô∏è‚É£ Seller approves ESTEEM, then deposits.<br>
    4Ô∏è‚É£ Buyer loads escrow, verifies terms, then clicks ‚ÄúBuy with PLS.‚Äù<br>
    5Ô∏è‚É£ Once done, both can see completion status. If buyer never buys, seller refunds after deadline.<br><br>
    <i>Each step prints live log messages below and disables completed buttons to prevent mistakes.</i>
  </p>

  <script>
    const FACTORY = "0xb42529b2A66FD430a872788c83b10B285886b963";
    const ESTEEM = "0x9FdCE721C528E6DBc4F494F3E80b9B28A3059Ab5";
    const factoryABI = [
      "function createEscrow(address,address,uint256,uint256,uint256) external returns (address)",
      "event EscrowCreated(address indexed creator,address escrowAddress)"
    ];
    const escrowABI = [
      "function seller() view returns (address)",
      "function buyer() view returns (address)",
      "function esteemAmount() view returns (uint256)",
      "function plsAmount() view returns (uint256)",
      "function deposited() view returns (bool)",
      "function settled() view returns (bool)",
      "function deadline() view returns (uint256)",
      "function depositEsteem() external",
      "function buy() external payable",
      "function refund() external"
    ];

    let provider, signer, userAddr;

    function log(msg){document.getElementById("log").innerText = msg; console.log(msg);}
    function showLoading(b){document.getElementById("loadingOverlay").style.display=b?"flex":"none";}
    function toWei(n){return ethers.parseEther(n.toString());}

    async function connect(){
      try{
        if(!window.ethereum) return alert("Please install MetaMask or OKX Wallet.");
        provider=new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts",[]);
        signer=await provider.getSigner();
        userAddr=await signer.getAddress();
        document.getElementById("walletInfo").innerText="Connected: "+userAddr;
        ["createBtn","loadBtn"].forEach(id=>document.getElementById(id).disabled=false);

        // Only autofill seller for escrow creation if no ?escrow param
        const escrowParam = new URLSearchParams(window.location.search).get("escrow");
        if(!escrowParam){
          const sellerInput = document.getElementById("seller");
          if(sellerInput) sellerInput.value = userAddr;
        }

        document.getElementById("statusBox").innerText="Wallet connected.";
      }catch(e){alert("Connect failed: "+e.message);}
    }

    async function createEscrow(){
      try{
        showLoading(true);
        const f = new ethers.Contract(FACTORY, factoryABI, signer);
        const buyer=document.getElementById("buyerAddr").value;
        const esteemAmt=toWei(document.getElementById("esteemAmt").value);
        const plsAmt=toWei(document.getElementById("plsPrice").value);
        const minutes=parseInt(document.getElementById("deadline").value);
        const deadlineUnix=Math.floor(Date.now()/1000)+(minutes*60);
        const tx=await f.createEscrow(userAddr,buyer,esteemAmt,plsAmt,deadlineUnix);
        const rcpt=await tx.wait();
        const evt=rcpt.logs?.find(l=>l.fragment?.name==="EscrowCreated");
        const addr=evt?evt.args.escrowAddress:"(unknown)";
        const shareLink=`${window.location.origin}${window.location.pathname}?escrow=${addr}`;
        document.getElementById("newEscrow").innerHTML=
          `‚úÖ Escrow created!<br><b>Share this link with buyer:</b><br>
          <a href="${shareLink}" target="_blank">${shareLink}</a>`;
        document.getElementById("escrowAddr").value=addr;
      }catch(e){log("Error: "+e.message);}
      finally{showLoading(false);}
    }

    function getEscrow(){
      const addr=document.getElementById("escrowAddr").value.trim();
      if(!ethers.isAddress(addr)) throw new Error("Invalid escrow address");
      return new ethers.Contract(addr, escrowABI, signer);
    }

    async function loadEscrow(){
      try{
        const e=getEscrow();
        const [seller,buyer,esteem,pls,dep,sett]=await Promise.all([
          e.seller(),e.buyer(),e.esteemAmount(),e.plsAmount(),e.deposited(),e.settled()
        ]);
        const sBox=document.getElementById("statusBox");
        sBox.innerText=`Seller: ${seller}\nBuyer: ${buyer}\nDeposited: ${dep}\nSettled: ${sett}\n\nEsteem: ${ethers.formatEther(esteem)}\nPrice: ${ethers.formatEther(pls)} PLS`;
        await refreshEscrowState(e);
      }catch(e){log("Verify error: "+e.message);}
    }

    async function approveEsteem(){
      try{
        showLoading(true);
        const e=getEscrow();
        const token=new ethers.Contract(ESTEEM,["function approve(address,uint256) public returns(bool)"],signer);
        const amt=toWei(document.getElementById("esteemAmt").value);
        const tx=await token.approve(document.getElementById("escrowAddr").value,amt);
        await tx.wait();
        document.getElementById("approveBtn").disabled=true;
        log("‚úÖ Esteem approved.");
      }catch(e){log("Approval error: "+e.message);}
      finally{showLoading(false);}
    }

    async function depositEsteem(){
      try{
        showLoading(true);
        const e=getEscrow();
        const tx=await e.depositEsteem();
        await tx.wait();
        document.getElementById("depositBtn").disabled=true;
        log("‚úÖ Esteem deposited.");
        await refreshEscrowState(e);
      }catch(e){log("Deposit error: "+e.message);}
      finally{showLoading(false);}
    }

    async function buy(){
      try{
        showLoading(true);
        const e=getEscrow();
        const pls=toWei(document.getElementById("plsPrice").value);
        const tx=await e.buy({value:pls});
        await tx.wait();
        log("‚úÖ Purchase complete!");
        document.getElementById("buyBtn").disabled=true;
      }catch(e){log("Buy error: "+e.message);}
      finally{showLoading(false);}
    }

    async function refund(){
      try{
        showLoading(true);
        const e=getEscrow();
        const tx=await e.refund();
        await tx.wait();
        log("‚úÖ Refunded to seller.");
      }catch(e){log("Refund error: "+e.message);}
      finally{showLoading(false);}
    }

    async function refreshEscrowState(e){
      try{
        const [dep,sett]=await Promise.all([e.deposited(),e.settled()]);
        const buyBtn=document.getElementById("buyBtn");
        if(dep && !sett){
          buyBtn.disabled=false;
          buyBtn.title="Seller deposited; ready to buy.";
        }else{
          buyBtn.disabled=true;
        }
      }catch(err){console.warn("refreshEscrowState",err);}
    }

    document.getElementById("connectBtn").onclick=connect;
    document.getElementById("createBtn").onclick=createEscrow;
    document.getElementById("loadBtn").onclick=loadEscrow;
    document.getElementById("approveBtn").onclick=approveEsteem;
    document.getElementById("buyBtn").onclick=buy;
    document.getElementById("refundBtn").onclick=refund;

    // Autoload if ?escrow param
    const escrowParam=new URLSearchParams(window.location.search).get("escrow");
    if(escrowParam){
      window.addEventListener("DOMContentLoaded",()=>{
        document.getElementById("escrowAddr").value=escrowParam;
        document.getElementById("loadBtn").disabled=false;
      });
    }
  </script>
</body>
</html>
