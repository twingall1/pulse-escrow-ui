<!DOCTYPE html>
sellerFunded: s[7], buyerFunded: s[8], status: Number(s[9])
};
last = { addr, ...data };
out.textContent = JSON.stringify(data, null, 2);
nxt.textContent = whoActsNext({sellerFunded:data.sellerFunded,buyerFunded:data.buyerFunded,deadline:data.deadline,status:data.status});
}catch(e){ out.textContent = '❌ '+(e.reason||e.message||e); }
};


$('copy').onclick = async () => {
const addr = $('escrowAddr').value.trim();
const url = location.origin + location.pathname + '?escrow=' + addr;
await navigator.clipboard.writeText(url);
};


/* ====== ALLOWANCES ====== */
$('checkAllowSeller').onclick = async () => {
const logBox = $('actionLog');
try {
if (!signer) throw new Error('Connect wallet first');
if (!last) throw new Error('Load summary first');
const esteem = new ethers.Contract(ESTEEM_ADDR, ERC20_ABI, provider);
const owner = await signer.getAddress();
const allowance = await esteem.allowance(owner, last.addr);
log(logBox, `Seller allowance ESTEEM→Escrow: ${allowance.toString()} (need ${last.amountSellWei})`);
} catch(e){ log(logBox, '❌ '+(e.reason||e.message||e)); }
};


$('approveSeller').onclick = async () => {
const logBox = $('actionLog');
try {
if (!signer) throw new Error('Connect wallet first');
if (!last) throw new Error('Load summary first');
const esteem = new ethers.Contract(ESTEEM_ADDR, ERC20_ABI, signer);
const tx = await esteem.approve(last.addr, BigInt(last.amountSellWei));
log(logBox, 'Approving ESTEEM… '+tx.hash);
await tx.wait();
log(logBox, '✅ ESTEEM approved');
} catch(e){ log(logBox, '❌ '+(e.reason||e.message||e)); }
};


$('checkAllowBuyer').onclick = async () => {
const logBox = $('actionLog');
try {
if (!signer) throw new Error('Connect wallet first');
if (!last) throw new Error('Load summary first');
const wpls = new ethers.Contract(WPLS_ADDR, ERC20_ABI, provider);
const owner = await signer.getAddress();
const allowance = await wpls.allowance(owner, last.addr);
log(logBox, `Buyer allowance WPLS→Escrow: ${allowance.toString()} (need ${last.amountBuyWei})`);
} catch(e){ log(logBox, '❌ '+(e.reason||e.message||e)); }
};


$('approveBuyer').onclick = async () => {
const logBox = $('actionLog');
try {
if (!signer) throw new Error('Connect wallet first');
if (!last) throw new Error('Load summary first');
const wpls = new ethers.Contract(WPLS_ADDR, ERC20_ABI, signer);
const tx = await wpls.approve(last.addr, BigInt(last.amountBuyWei));
log(logBox, 'Approving WPLS… '+tx.hash);
await tx.wait();
log(logBox, '✅ WPLS approved');
} catch(e){ log(logBox, '❌ '+(e.reason||e.message||e)); }
};


/* ====== ACTIONS ====== */
async function act(fn){
const logBox = $('actionLog');
try{
if (!signer) throw new Error('Connect wallet first');
if (!last) throw new Error('Load summary first');
const escrow = new ethers.Contract(last.addr, ESCROW_ABI, signer);
const tx = await escrow[fn]();
log(logBox, `${fn}… ${tx.hash}`);
await tx.wait();
log(logBox, `✅ ${fn} confirmed`);
$('load').click();
}catch(e){ log(logBox, '❌ '+(e.reason||e.message||e)); }
}
$('fundSeller').onclick = () => act('fundSeller');
$('fundBuyer').onclick = () => act('fundBuyer');
$('settle').onclick = () => act('settle');
$('refund').onclick = () => act('refund');
</script>
</body>
</html>
