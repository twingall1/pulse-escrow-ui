<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Pulsecrow ‚Äì Trustless Two-Party Escrow on PulseChain</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<style>
body{font-family:"Segoe UI",Roboto,sans-serif;background:#f8fafc;color:#222;
  max-width:640px;margin:40px auto;padding:24px;border-radius:16px;
  box-shadow:0 0 20px rgba(0,0,0,0.08);}
h1{text-align:center;}
input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:15px;}
button{background:#0084ff;color:#fff;font-weight:600;border:none;cursor:pointer;}
button:disabled{background:#ccc;cursor:not-allowed;}
button:hover:enabled{background:#006edc;}
.token-choice{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0;}
.token-choice label{display:flex;align-items:center;gap:4px;background:#fff;border:1px solid #ccc;padding:4px 8px;border-radius:6px;cursor:pointer;}
.logo-row{display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:10px;}
.crow{font-size:60px;line-height:1;}
#statusBox{background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:10px;white-space:pre-wrap;}
#instructions{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px;margin-top:40px;font-size:14px;line-height:1.55;}
.small{font-size:13px;color:#444;}
#loadingOverlay{position:fixed;inset:0;background:rgba(255,255,255,0.85);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:99999;}
.spinner{border:4px solid #ccc;border-top:4px solid #0084ff;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin-bottom:12px;}
@keyframes spin{100%{transform:rotate(360deg);}}
</style>
</head>

<body>
<div class="logo-row"><span style="font-size:36px;">‚ö°</span><span class="crow">üê¶‚Äç‚¨õ</span><span style="font-size:36px;">‚ö°</span></div>
<h1>Pulsecrow</h1>
<p style="text-align:center;">Trustless two-deposit escrow on <b>PulseChain</b><br>
<small>(Use MetaMask or OKX Wallet)</small><br>
<a href="#instructions" style="color:#0084ff;text-decoration:none;">üìò View Instructions</a></p>

<button id="connectBtn">üîó Connect Wallet</button>
<div id="walletInfo" class="small"></div>
<hr>

<!-- Shared Inputs -->
<h3>Party B (counterparty address)</h3>
<input id="partyB" placeholder="Counterparty wallet address" />

<h3>Token A</h3>
<div class="token-choice" id="tokenAchoices"></div>
<input id="tokenA" placeholder="Token A address" />
<input id="amountA" placeholder="Your amount (e.g. 1.5)" />
<input id="decA" placeholder="Token A decimals (e.g. 18)" />

<h3>Token B</h3>
<div class="token-choice" id="tokenBchoices"></div>
<input id="tokenB" placeholder="Token B address" />
<input id="amountB" placeholder="Their amount (e.g. 100)" />
<input id="decB" placeholder="Token B decimals (e.g. 18)" />

<h3>Deadline (minutes from now)</h3>
<input id="deadline" placeholder="e.g. 30" />

<h3>Escrow Actions</h3>
<input id="escrowAddr" placeholder="Paste or load escrow address" />
<div id="verifyBadge" class="small"></div>
<button id="createBtn" disabled>Create Escrow</button>
<button id="verifyBtn">Verify Inputs</button>
<button id="approveBtn" disabled>Approve My Token</button>
<button id="depositBtn" disabled>Deposit My Token</button>
<button id="settleBtn" disabled>Settle</button>
<button id="refundBtn" disabled>Refund</button>

<div id="newEscrow" class="small"></div>
<div id="statusBox">Status: not connected</div>

<div id="loadingOverlay"><div class="spinner"></div><div>‚è≥ Waiting for confirmation‚Ä¶</div></div>

<!-- Instructions -->
<div id="instructions">
<b>How to use Pulsecrow:</b><br><br>
<b>1.</b> Connect your wallet (MetaMask or OKX).<br>
<b>2.</b> Enter Party B‚Äôs wallet, choose tokens for A & B, enter amounts and deadline.<br>
<b>3.</b> Click <b>Create Escrow</b> to start a new one (share the link shown).<br>
<b>4.</b> Or paste an escrow address and click <b>Verify Inputs</b> to confirm you match.<br>
<b>5.</b> When verified, <b>Approve</b> (for ERC-20s) and <b>Deposit</b>. Native PLS needs no approval.<br><br>
<p class="small" style="text-align:center;">
üîç Official verified Pulsecrow factory contract:<br>
<a href="https://scan.pulsechain.com/address/0xb42529b2A66FD430a872788c83b10B285886b963"
target="_blank" style="color:#0084ff;">0xb42529b2A66FD430a872788c83b10B285886b963</a>
</p>
</div>

<script>
const FACTORY="0xb42529b2A66FD430a872788c83b10B285886b963";
const READONLY_RPC="https://rpc.pulsechain.com";

const TOKENS=[
  {name:"PLS (native)",addr:"0x0000000000000000000000000000000000000000",dec:18},
  {name:"WPLS",addr:"0xa10d38c309b7b86a0e0f34218c5a620b6245ff96",dec:18},
  {name:"PLSX",addr:"0xf6b2d434b4c65a2c26b2d60c7f7b2b3e57629193",dec:18},
  {name:"WETH",addr:"0xa722c13135930332eb3d749b2f0906559d2c5b99",dec:18},
  {name:"ESTEEM",addr:"0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5",dec:18}
];

const factoryABI=[
  "function createEscrow(address,address,address,address,uint256,uint256,uint256) external returns(address)",
  "event EscrowCreated(address indexed creator,address escrowAddress)"
];

const escrowABI=[
  "function partyA() view returns(address)","function partyB() view returns(address)",
  "function tokenA() view returns(address)","function tokenB() view returns(address)",
  "function amountA() view returns(uint256)","function amountB() view returns(uint256)",
  "function depositedA() view returns(bool)","function depositedB() view returns(bool)",
  "function depositA() external payable","function depositB() external payable",
  "function settle() external","function refundA() external","function refundB() external",
  "function deadline() view returns(uint256)"
];

let provider, signer, user, readonlyProvider = new ethers.JsonRpcProvider(READONLY_RPC);
const toWei = (v,d) => ethers.parseUnits(v.toString(), d);
const showLoad = b => document.getElementById("loadingOverlay").style.display=b?"flex":"none";

// Token toggles
function buildChoices(){
  ["A","B"].forEach(side=>{
    const box=document.getElementById(`token${side}choices`);
    TOKENS.forEach(t=>{
      const el=document.createElement("label");
      el.innerHTML=`<input type="radio" name="token${side}" value="${t.addr}" data-dec="${t.dec}">${t.name}`;
      el.querySelector("input").onchange=()=>{
        const addr=document.getElementById(`token${side}`);
        const dec=document.getElementById(`dec${side}`);
        addr.value=t.addr; dec.value=t.dec;
        addr.disabled=(t.addr==="0x0000000000000000000000000000000000000000");
      };
      box.appendChild(el);
    });
  });
}

// Connect wallet
async function connect(){
  if(!window.ethereum){alert("Install MetaMask or OKX Wallet");return;}
  provider=new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer=await provider.getSigner();
  user=await signer.getAddress();
  document.getElementById("walletInfo").innerText=`Connected: ${user}`;
  document.getElementById("createBtn").disabled=false;
}

// Create escrow
async function createEscrow(){
  try{
    if(!signer)return alert("Connect wallet first");
    showLoad(true);
    const f=new ethers.Contract(FACTORY,factoryABI,signer);
    const partyB=document.getElementById("partyB").value.trim();
    const tokenA=document.getElementById("tokenA").value.trim();
    const tokenB=document.getElementById("tokenB").value.trim();
    const decA=parseInt(document.getElementById("decA").value)||18;
    const decB=parseInt(document.getElementById("decB").value)||18;
    const amtA=toWei(document.getElementById("amountA").value,decA);
    const amtB=toWei(document.getElementById("amountB").value,decB);
    const mins=parseInt(document.getElementById("deadline").value)||30;
    const deadline=Math.floor(Date.now()/1000)+mins*60;

    const tx=await f.createEscrow(user,partyB,tokenA,tokenB,amtA,amtB,deadline);
    const rc=await tx.wait();
    const ev=rc.logs?.find(l=>l.fragment?.name==="EscrowCreated");
    const escrow=ev?ev.args.escrowAddress:"(unknown)";
    const link=`${location.origin}${location.pathname}?escrow=${escrow}`;
    document.getElementById("newEscrow").innerHTML=
      `‚úÖ Escrow created at:<br><code>${escrow}</code><br>üîó Share this link with your counterparty:<br><a href="${link}" target="_blank">${link}</a>`;
    document.getElementById("escrowAddr").value=escrow;
  }catch(e){alert("Create error: "+(e?.message||e));}
  finally{showLoad(false);}
}

// Verify inputs
async function verifyInputs(){
  try{
    const esc=document.getElementById("escrowAddr").value.trim();
    if(!ethers.isAddress(esc))return alert("Invalid escrow address");
    const e=new ethers.Contract(esc,escrowABI,provider||readonlyProvider);
    const [onA,onB,onAmtA,onAmtB]=await Promise.all([e.tokenA(),e.tokenB(),e.amountA(),e.amountB()]);
    const inA=document.getElementById("tokenA").value.trim();
    const inB=document.getElementById("tokenB").value.trim();
    const valA=parseFloat(document.getElementById("amountA").value);
    const valB=parseFloat(document.getElementById("amountB").value);
    const decA=parseInt(document.getElementById("decA").value)||18;
    const decB=parseInt(document.getElementById("decB").value)||18;
    if(isNaN(valA)||isNaN(valB)){document.getElementById("statusBox").innerText="‚ö†Ô∏è Enter numeric amounts.";return;}
    const amtA=toWei(valA,decA);const amtB=toWei(valB,decB);
    const match=inA.toLowerCase()===onA.toLowerCase()&&inB.toLowerCase()===onB.toLowerCase()&&amtA===onAmtA&&amtB===onAmtB;
    ["approveBtn","depositBtn","settleBtn","refundBtn"].forEach(id=>document.getElementById(id).disabled=!match);
    document.getElementById("statusBox").innerText=match?"‚úÖ Inputs match on-chain. You can proceed.":"‚ö†Ô∏è Inputs mismatch ‚Äì check tokens and amounts.";
  }catch(e){document.getElementById("statusBox").innerText="Verify error: "+(e?.message||e);}
}

// APPROVE
async function approve(){
  try{
    if(!signer)return alert("Connect wallet first");
    const esc=document.getElementById("escrowAddr").value.trim();
    if(!ethers.isAddress(esc))return alert("Invalid escrow address");
    const e=new ethers.Contract(esc,escrowABI,signer);
    const [partyA,partyB,tokenA,tokenB,amountA,amountB]=await Promise.all([
      e.partyA(),e.partyB(),e.tokenA(),e.tokenB(),e.amountA(),e.amountB()
    ]);
    const me=(await signer.getAddress()).toLowerCase();
    const isA=me===partyA.toLowerCase(),isB=me===partyB.toLowerCase();
    if(!isA&&!isB)return alert("This wallet is not part of the escrow.");
    const tokenAddr=isA?tokenA:tokenB,amt=isA?amountA:amountB;
    if(tokenAddr==="0x0000000000000000000000000000000000000000"){alert("‚úÖ Native PLS requires no approval.");return;}
    const token=new ethers.Contract(tokenAddr,["function allowance(address,address)view returns(uint256)","function approve(address,uint256)returns(bool)"],signer);
    const allowance=await token.allowance(me,esc);
    if(allowance>=amt){alert("‚úÖ Already approved.");return;}
    document.getElementById("statusBox").innerText="‚è≥ Waiting for approval confirmation...";
    const tx=await token.approve(esc,amt);await tx.wait();
    document.getElementById("statusBox").innerText="‚úÖ Approved successfully.";
  }catch(e){alert("Approval error: "+(e?.message||e));}
}

// DEPOSIT
async function deposit(){
  try{
    if(!signer)return alert("Connect wallet first");
    const esc=document.getElementById("escrowAddr").value.trim();
    if(!ethers.isAddress(esc))return alert("Invalid escrow address");
    const e=new ethers.Contract(esc,escrowABI,signer);
    const [partyA,partyB,tokenA,tokenB,amountA,amountB]=await Promise.all([
      e.partyA(),e.partyB(),e.tokenA(),e.tokenB(),e.amountA(),e.amountB()
    ]);
    const me=(await signer.getAddress()).toLowerCase();
    const isA=me===partyA.toLowerCase(),isB=me===partyB.toLowerCase();
    if(!isA&&!isB)return alert("‚ö†Ô∏è This wallet is not registered for this escrow.");
    const tokenAddr=isA?tokenA:tokenB,amt=isA?amountA:amountB;
    if(e.deadline){const dl=await e.deadline();if(Math.floor(Date.now()/1000)>dl)return alert("‚è∞ Deadline expired.");}
    if(tokenAddr!=="0x0000000000000000000000000000000000000000"){
      const t=new ethers.Contract(tokenAddr,["function allowance(address,address)view returns(uint256)"],signer);
      const allowance=await t.allowance(me,esc);
      if(allowance<amt)return alert("‚ö†Ô∏è Not approved or insufficient allowance.");
    }
    document.getElementById("statusBox").innerText="‚è≥ Waiting for deposit confirmation...";
    const tx=(tokenAddr==="0x0000000000000000000000000000000000000000")
      ?await(isA?e.depositA({value:amt}):e.depositB({value:amt}))
      :await(isA?e.depositA():e.depositB());
    await tx.wait();
    document.getElementById("statusBox").innerText="‚úÖ Deposit successful.";
  }catch(e){alert("Deposit error: "+(e?.reason||e?.message||e));}
}

// SETTLE
async function settle(){
  try{
    if(!signer)return alert("Connect wallet first");
    const e=new ethers.Contract(document.getElementById("escrowAddr").value.trim(),escrowABI,signer);
    document.getElementById("statusBox").innerText="‚è≥ Waiting for settle confirmation...";
    const tx=await e.settle();await tx.wait();
    document.getElementById("statusBox").innerText="‚úÖ Escrow settled. Tokens swapped.";
  }catch(e){alert("Settle error: "+(e?.message||e));}
}

// REFUND
async function refund(){
  try{
    if(!signer)return alert("Connect wallet first");
    const e=new ethers.Contract(document.getElementById("escrowAddr").value.trim(),escrowABI,signer);
    const a=await e.partyA(),me=(await signer.getAddress()).toLowerCase();
    const isA=me===a.toLowerCase();
    document.getElementById("statusBox").innerText="‚è≥ Waiting for refund confirmation...";
    const tx=await(isA?e.refundA():e.refundB());await tx.wait();
    document.getElementById("statusBox").innerText="‚úÖ Refund complete.";
  }catch(e){alert("Refund error: "+(e?.message||e));}
}

// Event listeners
document.getElementById("connectBtn").onclick=connect;
document.getElementById("createBtn").onclick=createEscrow;
document.getElementById("verifyBtn").onclick=verifyInputs;
document.getElementById("approveBtn").onclick=approve;
document.getElementById("depositBtn").onclick=deposit;
document.getElementById("settleBtn").onclick=settle;
document.getElementById("refundBtn").onclick=refund;
buildChoices();

// Autofill if shared link includes ?escrow=
const params=new URLSearchParams(window.location.search);
const esc=params.get("escrow");
if(esc){document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("escrowAddr").value=esc;
  document.getElementById("verifyBadge").innerText="üîç Loaded escrow: "+esc;
});}
</script>
</body>
</html>
