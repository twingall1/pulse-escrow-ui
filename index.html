<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulsecrow ‚Äì Trustless Two-Party Escrow on PulseChain</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<style>
:root{--primary:#0084ff;--bg:#f8fafc;--text:#222;}
html{scroll-behavior:smooth;}
body{font-family:"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);
max-width:680px;margin:40px auto;padding:24px;border-radius:16px;box-shadow:0 0 20px rgba(0,0,0,.08);}
h1,h2{text-align:center;}
input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;font-size:15px;}
button{background:var(--primary);color:#fff;font-weight:600;border:none;cursor:pointer;}
button:disabled{background:#ccc;cursor:not-allowed;}button:hover:enabled{background:#006edc;}
.section{margin-top:30px;}
.toggle-row{display:flex;flex-wrap:wrap;gap:10px;margin:6px 0 10px 0;}
.toggle{display:flex;align-items:center;gap:4px;font-size:0.85em;background:#fff;border:1px solid #ddd;
padding:3px 6px;border-radius:6px;}
.toggle input{transform:scale(1.1);accent-color:var(--primary);cursor:pointer;}
#statusBox{background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:10px;white-space:pre-wrap;}
#loadingOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.85);
display:none;align-items:center;justify-content:center;flex-direction:column;font-size:1.2em;color:#333;z-index:9999;}
.spinner{border:4px solid #ccc;border-top:4px solid var(--primary);border-radius:50%;
width:42px;height:42px;animation:spin 1s linear infinite;margin-bottom:12px;}
@keyframes spin{100%{transform:rotate(360deg);}}
.small{font-size:0.9em;color:#555;}
.crow{font-size:60px;line-height:1;}
.logo-row{display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:10px;}
.warning{color:#c00;font-size:0.85em;}
#instructions{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px;margin-top:40px;
font-size:14px;line-height:1.55;}
</style>
</head>
<body>
<div class="logo-row"><span style="font-size:36px;">‚ö°</span><span class="crow">üê¶‚Äç‚¨õ</span><span style="font-size:36px;">‚ö°</span></div>
<h1>Pulsecrow</h1>
<p style="text-align:center;">Trustless two-deposit escrow on <b>PulseChain</b><br>
<a href="#instructions" style="font-size:14px;color:#0084ff;text-decoration:none;">üìò View Instructions</a></p>

<button id="connectBtn">üîó Connect Wallet</button>
<div id="walletInfo" class="small"></div>
<hr>

<div class="section">
<h2>Create New Escrow</h2>
<input id="partyB" placeholder="Counterparty address (Party B)">
<input id="tokenA" placeholder="Your Token A address"><div id="warnA" class="warning"></div>
<div class="toggle-row" id="rowA"></div>
<input id="amountA" placeholder="Your amount (e.g. 1.5)">
<input id="decA" placeholder="Token A decimals (e.g. 18)">

<input id="tokenB" placeholder="Their Token B address"><div id="warnB" class="warning"></div>
<div class="toggle-row" id="rowB"></div>
<input id="amountB" placeholder="Their amount (e.g. 100)">
<input id="decB" placeholder="Token B decimals (e.g. 18)">
<input id="deadline" placeholder="Deadline (minutes from now)">
<button id="createBtn" disabled>Create Escrow</button>
<div id="newEscrow" class="small"></div>
</div>

<div class="section">
<h2>Join Existing Escrow</h2>
<input id="escrowAddr" placeholder="Paste Escrow Address">
<button id="verifyBtn">Verify Details</button>
<button id="approveBtn" disabled>Approve My Token</button>
<button id="depositBtn" disabled>Deposit My Token</button>
<button id="settleBtn" disabled>Settle</button>
<button id="refundBtn" disabled>Refund</button>
<div id="statusBox">Status: not connected</div>
</div>

<div id="loadingOverlay"><div class="spinner"></div><div>‚è≥ Waiting for confirmation‚Ä¶</div></div>

<div id="instructions">
<b>How to use Pulsecrow:</b><br><br>
1Ô∏è‚É£ Connect wallet (e.g. MetaMask or OKX).<br>
2Ô∏è‚É£ Select tokens from the 5 safe options or enter a whitelisted address.<br>
3Ô∏è‚É£ Enter amounts and deadline, then Create Escrow and share the link.<br>
4Ô∏è‚É£ Your counterparty must enter the same details and click Verify before joining.<br>
5Ô∏è‚É£ Once both deposit, either can Settle. If deadline passes, Refund is enabled.<br><br>
‚ö†Ô∏è Native PLS cannot be used directly ‚Äî wrap it into WPLS.<br><br>
üîç Official verified Pulsecrow factory contract:<br>
<a href="https://scan.pulsechain.com/address/0xDf370c23b14E694117C930a46656e0750b08c301"
target="_blank" style="color:#0084ff;">0xDf370c23b14E694117C930a46656e0750b08c301</a>
</div>

<script>
const FACTORY="0xDf370c23b14E694117C930a46656e0750b08c301";
const TOKENS={
  "PLS":   {addr:"0x7049dB2dEa5C2314E7354a6B9C44CdbC73367F1B",dec:18},
  "WPLS":  {addr:"0xA10D38c309B7B86A0e0F34218C5a620b6245Ff96",dec:18},
  "PLSX":  {addr:"0xF6B2D434B4C65A2C26B2D60C7F7B2B3E57629193",dec:18},
  "WETH":  {addr:"0xA722C13135930332Eb3d749B2F0906559D2C5b99",dec:18},
  "ESTEEM":{addr:"0x9FdCE721C528E6DBc4F494F3E80b9B28A3059Ab5",dec:18}
};
const whitelist=Object.values(TOKENS).map(t=>t.addr.toLowerCase());

const factoryABI=[
 "function createEscrow(address,address,address,address,uint256,uint256,uint256) external returns (address)",
 "event EscrowCreated(address indexed creator,address escrowAddress)"
];
const escrowABI=[
 "function depositA() external","function depositB() external","function settle() external",
 "function refundA() external","function refundB() external",
 "function partyA() view returns(address)","function partyB() view returns(address)",
 "function tokenA() view returns(address)","function tokenB() view returns(address)",
 "function amountA() view returns(uint256)","function amountB() view returns(uint256)",
 "function depositedA() view returns(bool)","function depositedB() view returns(bool)"
];

let provider,signer,userAddr;
const showLoad=s=>document.getElementById("loadingOverlay").style.display=s?"flex":"none";
const toWei=(a,d)=>BigInt(Math.round(parseFloat(a)*10**d));

async function connect(){
 if(!window.ethereum)return alert("Install MetaMask or OKX Wallet.");
 provider=new ethers.BrowserProvider(window.ethereum);
 await provider.send("eth_requestAccounts",[]);
 signer=await provider.getSigner();userAddr=await signer.getAddress();
 document.getElementById("walletInfo").innerText=`Connected: ${userAddr}`;
 ["createBtn"].forEach(id=>document.getElementById(id).disabled=false);
 document.getElementById("statusBox").innerText="Wallet connected.";
}

// ---- Create Escrow ----
async function createEscrow(){
 try{
  showLoad(true);
  const f=new ethers.Contract(FACTORY,factoryABI,signer);
  const aA=toWei(tokenA_amt.value,parseInt(decA.value));
  const aB=toWei(tokenB_amt.value,parseInt(decB.value));
  const mins=parseInt(deadline.value);
  const dUnix=Math.floor(Date.now()/1000)+(mins*60);
  const tx=await f.createEscrow(userAddr,partyB.value,tokenA.value,tokenB.value,aA,aB,dUnix);
  const rcpt=await tx.wait();const evt=rcpt.logs?.find(l=>l.fragment?.name==="EscrowCreated");
  const addr=evt?evt.args.escrowAddress:"(unknown)";
  const link=`${location.origin}${location.pathname}?escrow=${addr}`;
  newEscrow.innerHTML=`‚úÖ Escrow created:<br><code>${addr}</code><br><a href="${link}" target="_blank">${link}</a>`;
  escrowAddr.value=addr;
 }catch(e){alert("Error: "+e.message);}finally{showLoad(false);}
}

// ---- Verify User B Inputs ----
async function verifyUserBInputs(){
 try{
  const esc=escrowAddr.value.trim();if(!ethers.isAddress(esc))return alert("Bad address");
  const e=new ethers.Contract(esc,escrowABI,provider);
  const [onA,onB,onAmtA,onAmtB]=await Promise.all([e.tokenA(),e.tokenB(),e.amountA(),e.amountB()]);
  const inA=tokenA.value.trim(),inB=tokenB.value.trim();
  const inAmtA=toWei(amountA.value,parseInt(decA.value));
  const inAmtB=toWei(amountB.value,parseInt(decB.value));
  const match=inA.toLowerCase()===onA.toLowerCase()&&inB.toLowerCase()===onB.toLowerCase()&&inAmtA===onAmtA&&inAmtB===onAmtB;
  const buttons=["approveBtn","depositBtn","settleBtn","refundBtn"].map(id=>document.getElementById(id));
  if(match){buttons.forEach(b=>b.disabled=false);statusBox.innerText="‚úÖ Verified: Inputs match escrow.";}
  else{buttons.forEach(b=>b.disabled=true);statusBox.innerText="‚ö†Ô∏è Mismatch ‚Äî escrow details differ.";}
 }catch(e){statusBox.innerText="Verification error: "+e.message;}
}

// ---- Approve/Deposit/Settle/Refund ----
const getEsc=()=>new ethers.Contract(escrowAddr.value,escrowABI,signer);
async function approve(){try{showLoad(true);const e=getEsc();const a=await e.partyA(),b=await e.partyB();
const isA=userAddr.toLowerCase()===a.toLowerCase();const tokenAddr=isA?await e.tokenA():await e.tokenB();
const amt=isA?await e.amountA():await e.amountB();const t=new ethers.Contract(tokenAddr,["function approve(address,uint256) public returns(bool)"],signer);
await (await t.approve(escrowAddr.value,amt)).wait();alert("Approved!");}catch(e){alert(e.message);}finally{showLoad(false);}}
async function deposit(){try{showLoad(true);const e=getEsc();const a=await e.partyA();const isA=userAddr.toLowerCase()===a.toLowerCase();
await (await (isA?e.depositA():e.depositB())).wait();alert("Deposit complete!");}catch(e){alert(e.message);}finally{showLoad(false);}}
async function settle(){try{showLoad(true);await (await getEsc().settle()).wait();alert("Settled!");}catch(e){alert(e.message);}finally{showLoad(false);}}
async function refund(){try{showLoad(true);const e=getEsc();const a=await e.partyA();const isA=userAddr.toLowerCase()===a.toLowerCase();
await (await (isA?e.refundA():e.refundB())).wait();alert("Refunded.");}catch(e){alert(e.message);}finally{showLoad(false);}}

// ---- Token toggle & whitelist check ----
function setupTokenRows(){
 for(const side of["A","B"]){
  const row=document.getElementById("row"+side);
  for(const [sym,t] of Object.entries(TOKENS)){
   const box=document.createElement("div");box.className="toggle";
   const cb=document.createElement("input");cb.type="checkbox";cb.id=`${sym}${side}`;
   const lb=document.createElement("label");lb.htmlFor=cb.id;lb.innerText=sym;
   cb.addEventListener("change",()=>{for(const el of row.querySelectorAll("input"))if(el!==cb)el.checked=false;
    if(cb.checked){document.getElementById("token"+side).value=t.addr;
    document.getElementById("dec"+side).value=t.dec;document.getElementById("token"+side).disabled=document.getElementById("dec"+side).disabled=true;}
    else{document.getElementById("token"+side).disabled=document.getElementById("dec"+side).disabled=false;
    document.getElementById("token"+side).value="";document.getElementById("dec"+side).value="";}});
   box.append(cb,lb);row.append(box);
  }
 }
 ["tokenA","tokenB"].forEach(id=>{
  document.getElementById(id).addEventListener("input",e=>{
    const v=e.target.value.trim().toLowerCase();const warn=document.getElementById(id==="tokenA"?"warnA":"warnB");
    if(v&&v.startsWith("0x")&&!whitelist.includes(v))warn.innerText="‚ö†Ô∏è Not a whitelisted token.";
    else warn.innerText="";
  });
 });
}

// ---- Event wiring ----
connectBtn.onclick=connect;createBtn.onclick=createEscrow;verifyBtn.onclick=verifyUserBInputs;
approveBtn.onclick=approve;depositBtn.onclick=deposit;settleBtn.onclick=settle;refundBtn.onclick=refund;
setupTokenRows();
</script>
</body>
</html>
