<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trustless Atomic Swap â€“ PulseChain (369)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.min.js"></script>
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 900px; margin: 28px auto; padding: 0 14px; }
  h2 { margin-top: 0; }
  fieldset { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-bottom: 18px; }
  label { display:block; margin-top:8px; }
  input { width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:8px; }
  small { color:#666; }
  button { margin-top:10px; padding:10px 14px; border:0; border-radius:10px; background:#222; color:white; cursor:pointer; }
  button:disabled { opacity:0.5; cursor:not-allowed; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  #log { background:#f8f8f8; padding:12px; border-radius:10px; white-space:pre-wrap; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .ok { color: #128a23; }
  .warn { color: #a05a00; }
  .err { color: #b00020; }
  a { color:#0a58ca; text-decoration:none; }
</style>
</head>
<body>
<h2>Trustless Atomic Escrow â€“ PulseChain (369)</h2>
<p>Factory-spawned, per-trade escrow with deterministic addresses (CREATE2). No owner. No upgrades. Fully atomic swap.</p>

<button id="connectBtn">1) Connect Wallet</button>
<button id="switchBtn">2) Switch to PulseChain</button>

<fieldset>
  <legend><b>Create / Predict</b></legend>
  <div class="row">
    <div>
      <label>Party A (sender of Token A) <input id="partyA" placeholder="0x..." /></label>
      <label>Token A address <input id="tokenA" placeholder="ESTEEM address (paste here)" /></label>
      <label>Amount A (human units) <input id="amountA" type="number" step="any" placeholder="e.g., 123.45" /></label>
    </div>
    <div>
      <label>Party B (sender of Token B) <input id="partyB" placeholder="0x..." /></label>
      <label>Token B address <input id="tokenB" value="0xefd766ccb38eaf1dfd701853bfce31359239f305" /></label>
      <label>Amount B (human units) <input id="amountB" type="number" step="any" placeholder="e.g., 678.90" /></label>
    </div>
  </div>
  <label>Deadline (Unix timestamp, future) <input id="deadline" type="number" placeholder="e.g., now + 48h" /></label>

  <div class="row">
    <div>
      <label>Factory Address (deployed by you) 
        <input id="factoryAddr" placeholder="0x..." />
      </label>
    </div>
    <div>
      <label>Computed Escrow Address 
        <input id="predicted" class="mono" readonly />
      </label>
    </div>
  </div>

  <button id="predictBtn">Predict Escrow Address</button>
  <button id="deployBtn">Deploy Escrow</button>
  <div id="preview"></div>
</fieldset>

<fieldset>
  <legend><b>Interact with an existing Escrow</b></legend>
  <label>Escrow Address <input id="escrowAddr" placeholder="0x..." /></label>
  <div class="row">
    <button id="readAllBtn">Read Parameters & Status</button>
    <button id="statusBtn">Refresh Status</button>
  </div>

  <div class="row">
    <div>
      <button id="approveA">Approve A Amount</button>
      <button id="depositA">Deposit A</button>
    </div>
    <div>
      <button id="approveB">Approve B Amount</button>
      <button id="depositB">Deposit B</button>
    </div>
  </div>

  <div class="row">
    <div><button id="settleBtn">Settle (Atomic)</button></div>
    <div><button id="refundBtn">Refund (after deadline)</button></div>
  </div>

  <div id="links"></div>
</fieldset>

<fieldset>
  <legend><b>Log</b></legend>
  <div id="log"></div>
</fieldset>

<script>
/* ---------- CONFIG ---------- */
const DEFAULT_FACTORY = "0x571594b57fa8E8c2Cd426ABe4D91D2d594755a90"; // ðŸ‘ˆ Replace with your deployed factory
const PLS_CHAIN_ID_HEX = "0x171"; // 369 decimal
const PLS_RPC = "https://rpc.pulsechain.com";
const PLS_EXPLORER = "https://explorer.pulsechain.com";
const SOURCIFY_BASE = "https://repo.sourcify.dev/369";

/* ---------- ABIs ---------- */
const FACTORY_ABI = [
  "event SwapCreated(address indexed escrow, address indexed partyA, address indexed partyB)",
  "function predictAddress(address,address,address,address,uint256,uint256,uint256) view returns (address)",
  "function createSwap(address,address,address,address,uint256,uint256,uint256) returns (address)"
];
const ESCROW_ABI = [
  "function partyA() view returns (address)",
  "function partyB() view returns (address)",
  "function tokenA() view returns (address)",
  "function tokenB() view returns (address)",
  "function amountA() view returns (uint256)",
  "function amountB() view returns (uint256)",
  "function deadline() view returns (uint256)",
  "function depositedA() view returns (bool)",
  "function depositedB() view returns (bool)",
  "function status() view returns (bool,bool,uint256,bool)",
  "function depositA()",
  "function depositB()",
  "function settle()",
  "function refund()"
];
const ERC20_ABI = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 value) returns (bool)"
];

/* ---------- GLOBALS ---------- */
let provider, signer;

/* ---------- HELPERS ---------- */
function $(id){ return document.getElementById(id); }
function log(msg, cls){ $("log").innerHTML = `<div class="${cls||""}">${msg}</div>\n` + $("log").innerHTML; }
function a(href, text){ return `<a href="${href}" target="_blank">${text}</a>`; }

/* ---------- CONNECT / SWITCH ---------- */
async function connect(){
  if(!window.ethereum){ log("No wallet found. Install MetaMask.", "err"); return; }
  await ethereum.request({method:"eth_requestAccounts"});
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  log(`Connected: ${await signer.getAddress()}`, "ok");
}
async function switchToPulse(){
  try{
    await ethereum.request({method:"wallet_switchEthereumChain", params:[{chainId:PLS_CHAIN_ID_HEX}]});
    log("Switched to PulseChain", "ok");
  }catch(e){
    if(e.code===4902){
      await ethereum.request({
        method:"wallet_addEthereumChain",
        params:[{chainId:PLS_CHAIN_ID_HEX, chainName:"PulseChain", rpcUrls:[PLS_RPC],
          nativeCurrency:{name:"PLS",symbol:"PLS",decimals:18}, blockExplorerUrls:[PLS_EXPLORER]}]
      });
    } else log(`Switch error: ${e.message}`, "err");
  }
}

/* ---------- CORE FUNCTIONS (Predict, Deploy, Read, etc.) ---------- */
async function getFactoryAddr(){
  return $("factoryAddr").value.trim() || DEFAULT_FACTORY;
}

/* (â€¦ keep the rest of the large script from the previous working version exactly the same â€¦)
   You donâ€™t need to alter any other lines; every place that previously did:
   const fAddr = $("factoryAddr").value.trim();
   can now simply call getFactoryAddr().
*/
</script>
</body>
</html>
