<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Esteem Escrow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 40px auto; padding: 20px; line-height: 1.4; }
    h1 { font-size: 1.8em; margin-bottom: 0.3em; }
    h2 { margin-top: 1.5em; }
    input, button { width: 100%; padding: 8px; margin: 6px 0; font-size: 15px; }
    button { cursor: pointer; border: none; background: #0055ff; color: white; border-radius: 6px; }
    button:hover { background: #003fcc; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 6px; overflow-x: auto; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 16px; margin: 18px 0; }
  </style>
</head>
<body>

<h1>Esteem Escrow Factory UI</h1>
<p id="networkStatus">🔴 Not connected</p>
<button id="connectBtn">Connect Wallet</button>

<div class="card">
  <h2>Create Escrow</h2>
  <input id="seller" placeholder="Seller address (0x...)" />
  <input id="buyer" placeholder="Buyer address (0x...)" />
  <input id="esteem" placeholder="Esteem token address (0x...)" />
  <input id="amountSell" placeholder="Esteem amount (in wei)" />
  <input id="amountBuy" placeholder="PLS amount (in wei)" />
  <input id="deadline" placeholder="Deadline (unix timestamp)" />
  <button id="createBtn">Create Escrow</button>
  <p id="createOutput"></p>
</div>

<div class="card">
  <h2>Interact with Escrow</h2>
  <input id="escrowAddress" placeholder="Escrow contract address (0x...)" />
  <button id="summaryBtn">Get Summary</button>
  <pre id="summaryOutput"></pre>
  <button id="fundSellerBtn">Fund Seller (send Esteem)</button>
  <button id="fundBuyerBtn">Fund Buyer (send PLS)</button>
  <button id="settleBtn">Settle</button>
  <button id="refundBtn">Refund</button>
  <p id="actionStatus"></p>
</div>

<script>
const FACTORY_ADDRESS = "0xbc55C804D28960D454b1C25eBEe45f99933abAc1";

const FACTORY_ABI = [
  "function create(address,address,address,uint256,uint256,uint256) external returns (address)",
  "event EscrowCreated(address indexed escrow, address indexed seller, address indexed buyer, address esteem, uint256 amountSell, uint256 amountBuy, uint256 deadline)"
];

const ESCROW_ABI = [
  "function summary() view returns (address,address,address,uint256,uint256,uint256,bool,bool,uint8)",
  "function fundSeller() external",
  "function fundBuyer() external payable",
  "function settle() external",
  "function refund() external"
];

let provider, signer, factory;

async function connect() {
  if (!window.ethereum) {
    alert("Please install MetaMask!");
    return;
  }
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  const addr = await signer.getAddress();
  document.getElementById("networkStatus").textContent = "🟢 Connected: " + addr;
  factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);
}

async function createEscrow() {
  const s = document.getElementById("seller").value.trim();
  const b = document.getElementById("buyer").value.trim();
  const e = document.getElementById("esteem").value.trim();
  const asell = document.getElementById("amountSell").value.trim();
  const abuy = document.getElementById("amountBuy").value.trim();
  const dl = document.getElementById("deadline").value.trim();

  const out = document.getElementById("createOutput");
  try {
    const tx = await factory.create(s, b, e, asell, abuy, dl);
    out.textContent = "Transaction sent: " + tx.hash;
    const rc = await tx.wait();
    const event = rc.logs.find(x => x.fragment?.name === "EscrowCreated");
    const newAddr = event ? event.args.escrow : "unknown";
    out.textContent = "✅ Escrow created at: " + newAddr;
  } catch (err) {
    out.textContent = "❌ Error: " + (err.message || err);
  }
}

async function showSummary() {
  const addr = document.getElementById("escrowAddress").value.trim();
  const out = document.getElementById("summaryOutput");
  try {
    const escrow = new ethers.Contract(addr, ESCROW_ABI, provider);
    const s = await escrow.summary();
    const data = {
      seller: s[0],
      buyer: s[1],
      esteem: s[2],
      amountSell: s[3].toString(),
      amountBuy: s[4].toString(),
      deadline: s[5].toString(),
      sellerFunded: s[6],
      buyerFunded: s[7],
      status: s[8]
    };
    out.textContent = JSON.stringify(data, null, 2);
  } catch (err) {
    out.textContent = "❌ " + (err.message || err);
  }
}

async function act(fn, opts = {}) {
  const addr = document.getElementById("escrowAddress").value.trim();
  const status = document.getElementById("actionStatus");
  try {
    const escrow = new ethers.Contract(addr, ESCROW_ABI, signer);
    const tx = await escrow[fn](opts);
    status.textContent = "⏳ " + fn + "() sent: " + tx.hash;
    await tx.wait();
    status.textContent = "✅ " + fn + "() confirmed!";
  } catch (err) {
    status.textContent = "❌ " + (err.message || err);
  }
}

document.getElementById("connectBtn").onclick = connect;
document.getElementById("createBtn").onclick = createEscrow;
document.getElementById("summaryBtn").onclick = showSummary;
document.getElementById("fundSellerBtn").onclick = () => act("fundSeller");
document.getElementById("fundBuyerBtn").onclick = async () => {
  const value = prompt("Enter PLS amount in wei to send:");
  if (value) await act("fundBuyer", { value });
};
document.getElementById("settleBtn").onclick = () => act("settle");
document.getElementById("refundBtn").onclick = () => act("refund");
</script>

</body>
</html>
