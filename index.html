// --- APPROVE (with allowance check) ---
async function approve() {
  try {
    if (!signer) return alert("Connect wallet first");
    const esc = document.getElementById("escrowAddr").value.trim();
    if (!ethers.isAddress(esc)) return alert("Invalid escrow address");

    const e = new ethers.Contract(esc, escrowABI, signer);

    // Identify user role
    const [partyA, partyB, tokenA, tokenB, amountA, amountB] = await Promise.all([
      e.partyA(), e.partyB(), e.tokenA(), e.tokenB(), e.amountA(), e.amountB()
    ]);
    const me = (await signer.getAddress()).toLowerCase();
    const isA = me === partyA.toLowerCase();
    const isB = me === partyB.toLowerCase();

    if (!isA && !isB) {
      alert("This wallet is not part of the escrow. Connect the correct address.");
      return;
    }

    const tokenAddr = isA ? tokenA : tokenB;
    const amt = isA ? amountA : amountB;

    // If it's native PLS — skip approval
    if (tokenAddr === "0x0000000000000000000000000000000000000000") {
      alert("✅ Native PLS requires no approval.");
      return;
    }

    const token = new ethers.Contract(tokenAddr, [
      "function allowance(address owner,address spender) view returns(uint256)",
      "function approve(address,uint256) returns(bool)"
    ], signer);

    const allowance = await token.allowance(me, esc);
    if (allowance >= amt) {
      alert("✅ Token already approved — no need to approve again.");
      return;
    }

    // Ask user for approval
    document.getElementById("statusBox").innerText = "⏳ Waiting for approval confirmation...";
    const tx = await token.approve(esc, amt);
    console.log("Approve TX:", tx.hash);
    await tx.wait();

    document.getElementById("statusBox").innerText = "✅ Approved successfully.";
  } catch (err) {
    console.error(err);
    alert("Approval error: " + (err?.reason || err?.message || err));
  }
}

// --- DEPOSIT (safe version with deadline + role + allowance verification) ---
async function deposit() {
  try {
    if (!signer) return alert("Connect wallet first");
    const esc = document.getElementById("escrowAddr").value.trim();
    if (!ethers.isAddress(esc)) return alert("Invalid escrow address");

    const e = new ethers.Contract(esc, escrowABI, signer);

    // Read roles and amounts
    const [partyA, partyB, tokenA, tokenB, amountA, amountB] = await Promise.all([
      e.partyA(), e.partyB(), e.tokenA(), e.tokenB(), e.amountA(), e.amountB()
    ]);

    const me = (await signer.getAddress()).toLowerCase();
    const isA = me === partyA.toLowerCase();
    const isB = me === partyB.toLowerCase();

    if (!isA && !isB) {
      alert("⚠️ This wallet is not registered for this escrow.");
      return;
    }

    const tokenAddr = isA ? tokenA : tokenB;
    const amt = isA ? amountA : amountB;

    // Deadline check
    if (e.deadline) {
      const dl = await e.deadline();
      const now = Math.floor(Date.now() / 1000);
      if (now > dl) {
        alert("⏰ The escrow deadline has expired — deposits disabled.");
        return;
      }
    }

    // ERC-20 allowance check
    if (tokenAddr !== "0x0000000000000000000000000000000000000000") {
      const t = new ethers.Contract(tokenAddr, [
        "function allowance(address owner,address spender) view returns(uint256)"
      ], signer);
      const allowance = await t.allowance(me, esc);
      if (allowance < amt) {
        alert("⚠️ Token not approved or insufficient allowance. Please click 'Approve' first.");
        return;
      }
    }

    // Proceed with deposit
    document.getElementById("statusBox").innerText = "⏳ Waiting for deposit confirmation...";
    console.log(`Deposit: I am ${me}, partyA=${partyA}, partyB=${partyB}, isA=${isA}`);

    const tx = (tokenAddr === "0x0000000000000000000000000000000000000000")
      ? await (isA ? e.depositA({ value: amt }) : e.depositB({ value: amt }))
      : await (isA ? e.depositA() : e.depositB());

    console.log("Deposit TX:", tx.hash);
    await tx.wait();

    document.getElementById("statusBox").innerText = "✅ Deposit successful.";
  } catch (err) {
    console.error(err);
    alert("Deposit error: " + (err?.reason || err?.message || err));
  }
}
