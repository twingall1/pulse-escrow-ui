<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Pulsecrow ‚Äì Trustless Two-Party Escrow on PulseChain</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<style>
body{font-family:"Segoe UI",Roboto,sans-serif;background:#f8fafc;color:#222;
  max-width:640px;margin:40px auto;padding:24px;border-radius:16px;
  box-shadow:0 0 20px rgba(0,0,0,0.08);}
h1{text-align:center;}
input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;
  border:1px solid #ccc;font-size:15px;}
button{background:#0084ff;color:#fff;font-weight:600;border:none;cursor:pointer;}
button:disabled{background:#ccc;cursor:not-allowed;}
button:hover:enabled{background:#006edc;}
.token-choice{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0;}
.token-choice label{display:flex;align-items:center;gap:4px;background:#fff;
  border:1px solid #ccc;padding:4px 8px;border-radius:6px;cursor:pointer;}
.logo-row{display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:10px;}
.crow{font-size:60px;line-height:1;}
#statusBox{background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:10px;white-space:pre-wrap;}
#instructions{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px;margin-top:40px;font-size:14px;line-height:1.55;}
</style>
</head>

<body>
<div class="logo-row"><span style="font-size:36px;">‚ö°</span><span class="crow">üê¶‚Äç‚¨õ</span><span style="font-size:36px;">‚ö°</span></div>
<h1>Pulsecrow</h1>
<p style="text-align:center;">Trustless two-deposit escrow on <b>PulseChain</b><br>
<small>(Use MetaMask or OKX Wallet)</small><br>
<a href="#instructions" style="color:#0084ff;text-decoration:none;">üìò View Instructions</a></p>

<button id="connectBtn">üîó Connect Wallet</button>
<div id="walletInfo"></div>
<hr>

<!-- Shared Inputs for Create or Verify -->
<h3>Party B (counterparty address)</h3>
<input id="partyB" placeholder="Counterparty wallet address" />

<h3>Token A</h3>
<div class="token-choice" id="tokenAchoices"></div>
<input id="tokenA" placeholder="Token A address" />
<input id="amountA" placeholder="Your amount (e.g. 1.5)" />
<input id="decA" placeholder="Token A decimals (e.g. 18)" />

<h3>Token B</h3>
<div class="token-choice" id="tokenBchoices"></div>
<input id="tokenB" placeholder="Token B address" />
<input id="amountB" placeholder="Their amount (e.g. 100)" />
<input id="decB" placeholder="Token B decimals (e.g. 18)" />

<h3>Deadline (minutes from now)</h3>
<input id="deadline" placeholder="e.g. 30" />

<!-- Create & Join / Verify Buttons -->
<h3>Escrow Actions</h3>
<input id="escrowAddr" placeholder="Paste or load escrow address" />
<div id="verifyBadge"></div>
<button id="createBtn" disabled>Create Escrow</button>
<button id="verifyBtn">Verify Inputs</button>
<button id="approveBtn" disabled>Approve My Token</button>
<button id="depositBtn" disabled>Deposit My Token</button>
<button id="settleBtn" disabled>Settle</button>
<button id="refundBtn" disabled>Refund</button>

<div id="statusBox">Status: not connected</div>

<!-- Instructions -->
<div id="instructions">
<b>How to use Pulsecrow:</b><br><br>
<b>1.</b> Connect your wallet (MetaMask or OKX).<br>
<b>2.</b> Enter Party B‚Äôs wallet, tokens, amounts, and deadline.<br>
<b>3.</b> To create a new escrow, click <b>Create Escrow</b>.<br>
<b>4.</b> To join one, paste its address and click <b>Verify Inputs</b>.<br>
<b>5.</b> Once verified, Approve and Deposit will unlock.<br><br>
‚ö†Ô∏è Native PLS can be used directly (no approval step).<br><br>
<p style="text-align:center;font-size:13px;">
üîç Official verified Pulsecrow factory contract:<br>
<a href="https://scan.pulsechain.com/address/0xb42529b2A66FD430a872788c83b10B285886b963"
target="_blank" style="color:#0084ff;">0xb42529b2A66FD430a872788c83b10B285886b963</a>
</p>
</div>

<script>
const FACTORY="0xb42529b2A66FD430a872788c83b10B285886b963";
const TOKENS=[
 {name:"PLS (native)",addr:"0x0000000000000000000000000000000000000000",dec:18},
 {name:"WPLS",addr:"0xa10d38c309b7b86a0e0f34218c5a620b6245ff96",dec:18},
 {name:"PLSX",addr:"0xf6b2d434b4c65a2c26b2d60c7f7b2b3e57629193",dec:18},
 {name:"WETH",addr:"0xa722c13135930332eb3d749b2f0906559d2c5b99",dec:18},
 {name:"ESTEEM",addr:"0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5",dec:18}
];
const escrowABI=[
 "function tokenA() view returns(address)","function tokenB() view returns(address)",
 "function amountA() view returns(uint256)","function amountB() view returns(uint256)",
 "function depositA() external payable","function depositB() external payable",
 "function settle() external","function refundA() external","function refundB() external"
];
let provider,signer,user;
const toWei=(a,d)=>BigInt(Math.round(parseFloat(a)*10**d));

// Build toggle choices once
function buildChoices(){
 ["A","B"].forEach(side=>{
  const box=document.getElementById(`token${side}choices`);
  TOKENS.forEach(t=>{
   const el=document.createElement("label");
   el.innerHTML=`<input type="radio" name="token${side}" value="${t.addr}" data-dec="${t.dec}">${t.name}`;
   el.querySelector("input").onchange=()=>{
    const addr=document.getElementById(`token${side}`);
    const dec=document.getElementById(`dec${side}`);
    addr.value=t.addr; dec.value=t.dec;
    addr.disabled=(t.addr==="0x0000000000000000000000000000000000000000");
   };
   box.appendChild(el);
  });
 });
}

async function connect(){
 if(!window.ethereum)return alert("Install MetaMask or OKX");
 provider=new ethers.BrowserProvider(window.ethereum);
 await provider.send("eth_requestAccounts",[]);
 signer=await provider.getSigner();
 user=await signer.getAddress();
 document.getElementById("walletInfo").innerText=`Connected: ${user}`;
 document.getElementById("createBtn").disabled=false;
}

async function verifyInputs(){
 try{
  const esc=document.getElementById("escrowAddr").value.trim();
  if(!ethers.isAddress(esc))return alert("Invalid escrow address");
  const e=new ethers.Contract(esc,escrowABI,provider);
  const [onA,onB,onAmtA,onAmtB]=await Promise.all([e.tokenA(),e.tokenB(),e.amountA(),e.amountB()]);
  const inA=document.getElementById("tokenA").value.trim();
  const inB=document.getElementById("tokenB").value.trim();
  const valA=parseFloat(document.getElementById("amountA").value);
  const valB=parseFloat(document.getElementById("amountB").value);
  const decA=parseInt(document.getElementById("decA").value)||18;
  const decB=parseInt(document.getElementById("decB").value)||18;
  const amtA=toWei(valA,decA),amtB=toWei(valB,decB);
  const match=inA.toLowerCase()===onA.toLowerCase()&&inB.toLowerCase()===onB.toLowerCase()&&amtA===onAmtA&&amtB===onAmtB;
  ["approveBtn","depositBtn","settleBtn","refundBtn"].forEach(id=>document.getElementById(id).disabled=!match);
  document.getElementById("statusBox").innerText=match?"‚úÖ Inputs match. Proceed.":"‚ö†Ô∏è Mismatch ‚Äì check tokens and amounts.";
 }catch(e){document.getElementById("statusBox").innerText="Verify error: "+e.message;}
}

document.getElementById("connectBtn").onclick=connect;
document.getElementById("verifyBtn").onclick=verifyInputs;
buildChoices();

const params=new URLSearchParams(window.location.search);
const escrowParam=params.get("escrow");
if(escrowParam){
 document.getElementById("escrowAddr").value=escrowParam;
 document.getElementById("statusBox").innerText="üîç Escrow loaded: "+escrowParam;
}
</script>
</body>
</html>
