<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pulsecrow ‚Äì Trustless Two-Party Escrow on PulseChain</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<style>
html{scroll-behavior:smooth;}
body{font-family:"Segoe UI",Roboto,sans-serif;background:#f8fafc;color:#222;
      max-width:640px;margin:40px auto;padding:24px;border-radius:16px;
      box-shadow:0 0 20px rgba(0,0,0,0.08);}
h1,h2{text-align:center;}
input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;
             border:1px solid #ccc;font-size:15px;}
button{background:#0084ff;color:#fff;font-weight:600;border:none;cursor:pointer;}
button:disabled{background:#ccc;cursor:not-allowed;}
button:hover:enabled{background:#006edc;}
.section{margin-top:30px;}
.token-choice{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0;}
.token-choice label{display:flex;align-items:center;gap:4px;background:#fff;
  border:1px solid #ccc;padding:4px 8px;border-radius:6px;cursor:pointer;}
.divider{border-top:3px solid #ddd;margin:40px 0;}
.logo-row{display:flex;justify-content:center;align-items:center;gap:16px;margin-bottom:10px;}
.crow{font-size:60px;line-height:1;}
#statusBox{background:#fff;border:1px solid #ddd;border-radius:8px;
            padding:10px;margin-top:10px;white-space:pre-wrap;}
#loadingOverlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.85);
  display:none;align-items:center;justify-content:center;flex-direction:column;font-size:1.2em;color:#333;z-index:999999;}
.spinner{border:4px solid #ccc;border-top:4px solid #0084ff;border-radius:50%;
  width:42px;height:42px;animation:spin 1s linear infinite;margin-bottom:12px;}
@keyframes spin{100%{transform:rotate(360deg);}}
#instructions{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px;margin-top:40px;font-size:14px;line-height:1.55;}
.verify-box{background:#eef4ff;border:1px solid #c9dbff;padding:16px;border-radius:10px;margin-top:10px;}
</style>
</head>

<body>
<div class="logo-row"><span style="font-size:36px;">‚ö°</span><span class="crow">üê¶‚Äç‚¨õ</span><span style="font-size:36px;">‚ö°</span></div>
<h1>Pulsecrow</h1>
<p style="text-align:center;">
 Trustless two-deposit escrow on <b>PulseChain</b><br>
 <small>(Use MetaMask or OKX Wallet)</small><br>
 <a href="#instructions" style="color:#0084ff;text-decoration:none;">üìò View Instructions</a>
</p>

<button id="connectBtn">üîó Connect Wallet</button>
<div id="walletInfo" class="small"></div>
<hr>

<!-- CREATE ESCROW -->
<div class="section">
 <h2>Create Escrow</h2>
 <input id="partyB" placeholder="Counterparty address (Party B)" />

 <h3>Token A</h3>
 <div class="token-choice" id="tokenAchoices"></div>
 <input id="tokenA" placeholder="Token A address" />
 <input id="amountA" placeholder="Your amount (e.g. 1.5)" />
 <input id="decA" placeholder="Token A decimals (e.g. 18)" />

 <h3>Token B</h3>
 <div class="token-choice" id="tokenBchoices"></div>
 <input id="tokenB" placeholder="Token B address" />
 <input id="amountB" placeholder="Their amount (e.g. 100)" />
 <input id="decB" placeholder="Token B decimals (e.g. 18)" />

 <input id="deadline" placeholder="Deadline (minutes from now)" />
 <button id="createBtn" disabled>Create Escrow</button>
 <div id="newEscrow" class="small"></div>
</div>

<div class="divider"></div>

<!-- JOIN ESCROW -->
<div class="section">
 <h2>Join Escrow</h2>
 <input id="escrowAddr" placeholder="Paste escrow address or open link" />
 <div id="verifyBadge"></div>

 <div class="verify-box">
  <h3>Verify Token A</h3>
  <div class="token-choice" id="verifyAchoices"></div>
  <input id="verifyTokenA" placeholder="Token A address" />
  <input id="verifyAmtA" placeholder="Token A amount (e.g. 1.5)" />
  <input id="verifyDecA" placeholder="Token A decimals (e.g. 18)" />

  <h3>Verify Token B</h3>
  <div class="token-choice" id="verifyBchoices"></div>
  <input id="verifyTokenB" placeholder="Token B address" />
  <input id="verifyAmtB" placeholder="Token B amount (e.g. 100)" />
  <input id="verifyDecB" placeholder="Token B decimals (e.g. 18)" />
 </div>

 <button id="verifyBtn">Verify Inputs</button>
 <button id="approveBtn" disabled>Approve My Token</button>
 <button id="depositBtn" disabled>Deposit My Token</button>
 <button id="settleBtn" disabled>Settle</button>
 <button id="refundBtn" disabled>Refund</button>

 <div id="statusBox">Status: not connected</div>
</div>

<div id="loadingOverlay"><div class="spinner"></div><div>‚è≥ Waiting for confirmation‚Ä¶</div></div>

<!-- INSTRUCTIONS -->
<div id="instructions">
 <b>How to use Pulsecrow:</b><br><br>
 <b>1.</b> Connect your wallet (MetaMask or OKX).<br>
 <b>2.</b> Choose to <b>create</b> a new escrow or <b>join</b> an existing one.<br><br>
 <u>Creating an escrow:</u><br>
 ‚Ä¢ Enter Party B‚Äôs wallet address.<br>
 ‚Ä¢ Select tokens for A and B from the whitelist or use native PLS.<br>
 ‚Ä¢ Enter amounts and deadline (in minutes).<br>
 ‚Ä¢ Click <b>Create Escrow</b> and wait for confirmation.<br>
 ‚Ä¢ You‚Äôll get a link ‚Äî <b>share this link with your counterparty.</b><br><br>
 <u>Joining an escrow:</u><br>
 ‚Ä¢ Open the link or paste the escrow address.<br>
 ‚Ä¢ Select the same tokens and amounts as Party A.<br>
 ‚Ä¢ Click <b>Verify Inputs</b> to confirm a match with on-chain data.<br>
 ‚Ä¢ When verified, Approve/Deposit buttons unlock.<br>
 ‚Ä¢ Once both deposit, either side may <b>Settle</b>.<br>
 ‚Ä¢ If the deadline passes without both deposits, click <b>Refund</b>.<br><br>
 ‚ö†Ô∏è <b>Native PLS</b> can be used directly (no approval step).<br><br>
 <p style="text-align:center;font-size:13px;">
  üîç Official verified Pulsecrow factory contract:<br>
  <a href="https://scan.pulsechain.com/address/0xb42529b2A66FD430a872788c83b10B285886b963"
   target="_blank" style="color:#0084ff;">0xb42529b2A66FD430a872788c83b10B285886b963</a>
 </p>
</div>

<script>
const FACTORY="0xb42529b2A66FD430a872788c83b10B285886b963";
const TOKENS=[
 {name:"PLS (native)",addr:"0x0000000000000000000000000000000000000000",dec:18},
 {name:"WPLS",addr:"0xa10d38c309b7b86a0e0f34218c5a620b6245ff96",dec:18},
 {name:"PLSX",addr:"0xf6b2d434b4c65a2c26b2d60c7f7b2b3e57629193",dec:18},
 {name:"WETH",addr:"0xa722c13135930332eb3d749b2f0906559d2c5b99",dec:18},
 {name:"ESTEEM",addr:"0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5",dec:18}
];
const escrowABI=[
 "function tokenA() view returns(address)","function tokenB() view returns(address)",
 "function amountA() view returns(uint256)","function amountB() view returns(uint256)",
 "function depositA() external payable","function depositB() external payable",
 "function settle() external","function refundA() external","function refundB() external"
];
let provider,signer,user;
const toWei=(a,d)=>BigInt(Math.round(parseFloat(a)*10**d));
const showLoad=s=>document.getElementById("loadingOverlay").style.display=s?"flex":"none";

function buildChoices(){
 ["A","B","verifyA","verifyB"].forEach(side=>{
  const box=document.getElementById(`${side}choices`);
  if(!box)return;
  TOKENS.forEach(t=>{
   const el=document.createElement("label");
   el.innerHTML=`<input type="radio" name="token${side}" value="${t.addr}" data-dec="${t.dec}">${t.name}`;
   el.querySelector("input").onchange=()=>{
    const isVerify=side.includes("verify");
    const base=isVerify?"verify":"";
    const suffix=side.replace("verify","");
    const addr=document.getElementById(`${base}Token${suffix}`);
    const dec=document.getElementById(`${base}Dec${suffix}`);
    addr.value=t.addr;dec.value=t.dec;
    addr.disabled=(t.addr==="0x0000000000000000000000000000000000000000");
   };
   box.appendChild(el);
  });
 });
}

async function connect(){
 if(!window.ethereum)return alert("Install MetaMask or OKX");
 provider=new ethers.BrowserProvider(window.ethereum);
 await provider.send("eth_requestAccounts",[]);
 signer=await provider.getSigner();user=await signer.getAddress();
 document.getElementById("walletInfo").innerText=`Connected: ${user}`;
 document.getElementById("createBtn").disabled=false;
}

async function verifyUserBInputs(){
 try{
  const esc=document.getElementById("escrowAddr").value.trim();
  if(!ethers.isAddress(esc))return alert("Invalid escrow address");
  if(!provider)provider=new ethers.BrowserProvider(window.ethereum||null);
  const e=new ethers.Contract(esc,escrowABI,provider);
  const [onA,onB,onAmtA,onAmtB]=await Promise.all([e.tokenA(),e.tokenB(),e.amountA(),e.amountB()]);
  const inA=document.getElementById("verifyTokenA").value.trim();
  const inB=document.getElementById("verifyTokenB").value.trim();
  const valA=parseFloat(document.getElementById("verifyAmtA").value);
  const valB=parseFloat(document.getElementById("verifyAmtB").value);
  const decA=parseInt(document.getElementById("verifyDecA").value)||18;
  const decB=parseInt(document.getElementById("verifyDecB").value)||18;
  if(isNaN(valA)||isNaN(valB)){
   document.getElementById("statusBox").innerText="‚ö†Ô∏è Enter valid numeric amounts before verifying.";return;}
  const amtA=toWei(valA,decA),amtB=toWei(valB,decB);
  const match=inA.toLowerCase()===onA.toLowerCase()&&inB.toLowerCase()===onB.toLowerCase()&&amtA===onAmtA&&amtB===onAmtB;
  ["approveBtn","depositBtn","settleBtn","refundBtn"].forEach(id=>document.getElementById(id).disabled=!match);
  document.getElementById("statusBox").innerText=match?"‚úÖ Inputs match on-chain. You can proceed.":"‚ö†Ô∏è Inputs mismatch ‚Äì check tokens and amounts.";
 }catch(err){document.getElementById("statusBox").innerText="Verify error: "+err.message;}
}

document.getElementById("connectBtn").onclick=connect;
document.getElementById("verifyBtn").onclick=verifyUserBInputs;
buildChoices();

const params=new URLSearchParams(window.location.search);
const escrowParam=params.get("escrow");
if(escrowParam){
 document.getElementById("escrowAddr").value=escrowParam;
 document.getElementById("statusBox").innerText="üîç Escrow loaded: "+escrowParam;
}
</script>
</body>
</html>
