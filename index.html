<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Pulsecrow ‚Äì ESTEEM ‚Üî WPLS Escrow</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;max-width:760px;margin:32px auto;padding:18px;background:#f7fafc;color:#111}
  h1,h2{margin:0 0 8px}.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:14px 0}
  input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #cbd5e1;font-size:15px}
  button{background:#2563eb;color:#fff;border:none;font-weight:600;cursor:pointer}
  button:disabled{background:#9ca3af;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .muted{color:#555;font-size:13px}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .tokenradios{display:flex;gap:10px;flex-wrap:wrap}
  .radio{display:flex;align-items:center;gap:6px;border:1px solid #cbd5e1;padding:6px 10px;border-radius:8px;background:#fff;cursor:pointer}
  #overlay{position:fixed;inset:0;background:rgba(255,255,255,0.8);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:99999}
  .spinner{border:4px solid #ddd;border-top:4px solid #2563eb;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin-bottom:12px}
  @keyframes spin{100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<h1>Pulsecrow</h1>
<p class="muted">ESTEEM ‚Üî WPLS two-deposit escrow ‚Ä¢ PulseChain ‚Ä¢ Works with MetaMask / OKX</p>

<div class="card">
  <button id="connect">üîó Connect Wallet</button>
  <div id="who" class="muted"></div>
</div>

<div class="card">
  <h2>Create Escrow</h2>
  <div class="row">
    <input id="counterparty" placeholder="Counterparty address (the other wallet)">
    <input id="deadlineMins" placeholder="Deadline minutes (e.g. 30)">
  </div>

  <div class="row">
    <div>
      <b>Who will deposit ESTEEM?</b>
      <div class="tokenradios">
        <label class="radio"><input type="radio" name="esteemProvider" value="me">You</label>
        <label class="radio"><input type="radio" name="esteemProvider" value="them">Counterparty</label>
      </div>
      <input id="esteemAmount" placeholder="ESTEEM amount (e.g. 15)">
      <p class="muted">Token address 0x9FdCE721C528E6DBc4F494F3E80b9B28A3059Ab5 ‚Ä¢ 18 decimals</p>
    </div>
    <div>
      <b>Who will deposit WPLS?</b>
      <div class="tokenradios">
        <label class="radio"><input type="radio" name="wplsProvider" value="me">You</label>
        <label class="radio"><input type="radio" name="wplsProvider" value="them">Counterparty</label>
      </div>
      <input id="wplsAmount" placeholder="WPLS amount (e.g. 2000)">
      <p class="muted">Token address 0xA10D38c309B7B86A0e0F34218C5a620B6245Ff96 ‚Ä¢ 18 decimals</p>
    </div>
  </div>

  <button id="create" disabled>Create Escrow</button>
  <div id="created" class="muted"></div>
</div>

<div class="card">
  <h2>Verify / Join Escrow</h2>
  <input id="escrowAddr" placeholder="Escrow contract address (from link)">
  <button id="load">üîç Load On-Chain Details</button>
  <div id="verifystatus" class="muted"></div>
  <pre id="onchain" class="mono"></pre>
  <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <input type="checkbox" id="confirmMatch" disabled>
    <span>I confirm the on-chain details match our agreed terms.</span>
  </label>
  <div class="row" style="margin-top:8px;">
    <button id="approve" disabled>Approve My Token</button>
    <button id="deposit" disabled>Deposit My Token</button>
  </div>
  <div class="row">
    <button id="settle" disabled>Settle</button>
    <button id="refund" disabled>Refund</button>
  </div>
</div>

<div class="card">
  <h2>Status</h2>
  <div id="status" class="mono"></div>
</div>

<div id="overlay"><div class="spinner"></div><div>‚è≥ Waiting for confirmation‚Ä¶</div></div>

<script>
const READONLY_RPC="https://rpc.pulsechain.com";
const FACTORY="0x02bc02Ab0527550983Dc9A6E0c206090Eb347e15"; // üü¶ replace after deployment
const ESTEEM = "0x9FdCE721c528E6Dbc4F494F3e80B9b28A3059Ab5";
const WPLS   = "0xA10D38c309B7B86A0e0F34218C5a620B6245Ff96";
const DEC=18;

const factoryABI=[
 "function createEscrow(address,address,uint256,uint256,uint256) external returns(address)",
 "function createEscrow(address providerEsteem,address providerWpls,uint256 esteemAmount,uint256 wplsAmount,uint256 deadline) external returns(address)",
 "function EscrowCreated(address indexed creator,address escrow,address providerEsteem,address providerWpls,uint256 esteemAmount,uint256 wplsAmount,uint256 deadline) view",
 "event EscrowCreated(address indexed creator,address escrow,address providerEsteem,address providerWpls,uint256 esteemAmount,uint256 wplsAmount,uint256 deadline)"
];
const escrowABI=[
 "function providerEsteem() view returns(address)",
 "function providerWpls() view returns(address)",
 "function esteemAmount() view returns(uint256)",
 "function wplsAmount() view returns(uint256)",
 "function depositedEsteem() view returns(bool)",
 "function depositedWpls() view returns(bool)",
 "function deadline() view returns(uint256)",
 "function depositEsteem() external",
 "function depositWpls() external",
 "function settle() external",
 "function refundEsteem() external",
 "function refundWpls() external"
];
const erc20ABI=[
 "function allowance(address owner,address spender) view returns(uint256)",
 "function approve(address spender,uint256 amount) returns(bool)"
];
let providerRO=new ethers.JsonRpcProvider(READONLY_RPC);
let provider,signer,me;
const $=id=>document.getElementById(id);
const toWei=v=>ethers.parseUnits(String(v),DEC);
const toUnits=b=>Number(ethers.formatUnits(b,DEC));
const showWait=b=>$("overlay").style.display=b?"flex":"none";
const setStatus=msg=>$("status").textContent=msg;

/* ---------- Connect ---------- */
$("connect").onclick=async()=>{
 if(!window.ethereum)return alert("Install MetaMask or OKX");
 provider=new ethers.BrowserProvider(window.ethereum);
 await provider.send("eth_requestAccounts",[]);
 signer=await provider.getSigner();
 me=await signer.getAddress();
 $("who").textContent=`Connected: ${me}`;
 $("create").disabled=false;
};

/* ---------- Resolve providers ---------- */
function resolveProviders(counterparty){
 const eSel=document.querySelector('input[name="esteemProvider"]:checked')?.value;
 const wSel=document.querySelector('input[name="wplsProvider"]:checked')?.value;
 if(!eSel||!wSel)throw new Error("Select who deposits ESTEEM and WPLS");
 const providerEsteem=(eSel==="me")?me:counterparty;
 const providerWpls=(wSel==="me")?me:counterparty;
 if(providerEsteem.toLowerCase()===providerWpls.toLowerCase())
  throw new Error("Same wallet for both providers not allowed");
 return{providerEsteem,providerWpls};
}

/* ---------- CREATE ---------- */
$("create").onclick=async()=>{
 try{
  if(!signer)return alert("Connect wallet first");
  const counterparty=$("counterparty").value.trim();
  if(!ethers.isAddress(counterparty))return alert("Enter valid counterparty address");
  const esteemAmt=parseFloat($("esteemAmount").value);
  const wplsAmt=parseFloat($("wplsAmount").value);
  if(!(esteemAmt>0&&wplsAmt>0))return alert("Enter positive amounts");
  const mins=parseInt($("deadlineMins").value)||30;
  const deadline=Math.floor(Date.now()/1000)+mins*60;
  const{providerEsteem,providerWpls}=resolveProviders(counterparty);
  const f=new ethers.Contract(FACTORY,factoryABI,signer);

  /* Predict escrow address before broadcast */
  const predicted=await f.createEscrow.staticCall(
    providerEsteem,providerWpls,toWei(esteemAmt),toWei(wplsAmt),deadline);
  console.log("Predicted escrow address:",predicted);

  showWait(true);
  const tx=await f.createEscrow(providerEsteem,providerWpls,toWei(esteemAmt),toWei(wplsAmt),deadline);
  console.log("Create tx:",tx.hash);
  const rc=await tx.wait();

  /* Robust log parsing */
  let esc;
  try{
    const parsed=rc.logs.map(l=>f.interface.parseLog(l)).find(p=>p?.name==="EscrowCreated");
    esc=parsed?.args?.escrow;
  }catch{esc=null;}
  if(!esc){
    const addr=rc.logs.map(l=>l.address).find(a=>a!==FACTORY);
    esc=addr||predicted||"(unknown)";
  }

  if(esc&&esc!=="(unknown)"){
    const link=`${location.origin}${location.pathname}?escrow=${esc}`;
    $("created").innerHTML=`‚úÖ Escrow created at: <code>${esc}</code><br>üîó Share this link with your counterparty:<br><a href="${link}" target="_blank">${link}</a>`;
    $("escrowAddr").value=esc;
    setStatus("Escrow created successfully.");
  }else{
    $("created").innerHTML="‚ö†Ô∏è Escrow created but address unreadable. Check PulseScan.";
  }
 }catch(e){
  console.error(e);
  alert("Create error: "+(e.reason||e.message||e));
 }finally{showWait(false);}
};

/* ---------- VERIFY / JOIN ---------- */
$("load").onclick=async()=>{
 try{
  const esc=$("escrowAddr").value.trim();
  if(!ethers.isAddress(esc))return alert("Enter valid escrow address");
  const e=new ethers.Contract(esc,escrowABI,provider||providerRO);
  const[pE,pW,aE,aW,dE,dW,dl]=await Promise.all([
    e.providerEsteem(),e.providerWpls(),e.esteemAmount(),e.wplsAmount(),
    e.depositedEsteem(),e.depositedWpls(),e.deadline()
  ]);
  const summary=[
   `providerEsteem: ${pE}`,
   `providerWpls:   ${pW}`,
   `esteemAmount:   ${toUnits(aE)} (raw ${aE})`,
   `wplsAmount:    ${toUnits(aW)} (raw ${aW})`,
   `depositedEsteem:${dE}`,
   `depositedWpls:  ${dW}`,
   `deadline: ${new Date(Number(dl)*1000).toUTCString()} (unix ${dl})`
  ].join("\n");
  $("onchain").textContent=summary;
  $("verifystatus").textContent="‚úÖ Loaded on-chain details.";
  $("confirmMatch").disabled=false;
  $("confirmMatch").onchange=()=>{const ok=$("confirmMatch").checked;
    ["approve","deposit","settle","refund"].forEach(id=>$(id).disabled=!ok);}
 }catch(e){
  console.error(e);
  $("verifystatus").textContent="‚ùå Verify error: "+(e.message||e);
 }
};

/* ---------- APPROVE / DEPOSIT / SETTLE / REFUND ---------- */
const erc=(addr)=>new ethers.Contract(addr,erc20ABI,signer);
$("approve").onclick=async()=>{
 try{
  const e=new ethers.Contract($("escrowAddr").value.trim(),escrowABI,signer);
  const[pE,pW,aE,aW]=await Promise.all([e.providerEsteem(),e.providerWpls(),e.esteemAmount(),e.wplsAmount()]);
  const addr=(await signer.getAddress()).toLowerCase();
  showWait(true);
  if(addr===pE.toLowerCase()){
    const tx=await erc(ESTEEM).approve(e.target,aE);await tx.wait();setStatus("‚úÖ Approved ESTEEM.");
  }else if(addr===pW.toLowerCase()){
    const tx=await erc(WPLS).approve(e.target,aW);await tx.wait();setStatus("‚úÖ Approved WPLS.");
  }else alert("This wallet is not a provider.");
 }catch(e){alert("Approval error: "+(e.reason||e.message||e));}
 finally{showWait(false);}
};

$("deposit").onclick=async()=>{
 try{
  const e=new ethers.Contract($("escrowAddr").value.trim(),escrowABI,signer);
  const[pE,pW]=await Promise.all([e.providerEsteem(),e.providerWpls()]);
  const addr=(await signer.getAddress()).toLowerCase();
  showWait(true);
  let tx;
  if(addr===pE.toLowerCase()){tx=await e.depositEsteem();}
  else if(addr===pW.toLowerCase()){tx=await e.depositWpls();}
  else return alert("This wallet is not a provider.");
  await tx.wait();setStatus("‚úÖ Deposit complete.");
 }catch(e){alert("Deposit error: "+(e.reason||e.message||e));}
 finally{showWait(false);}
};
$("settle").onclick=async()=>{try{
 const e=new ethers.Contract($("escrowAddr").value.trim(),escrowABI,signer);
 showWait(true);const tx=await e.settle();await tx.wait();
 setStatus("‚úÖ Settled. Tokens swapped.");
}catch(e){alert("Settle error: "+(e.message||e));}finally{showWait(false);}};
$("refund").onclick=async()=>{try{
 const e=new ethers.Contract($("escrowAddr").value.trim(),escrowABI,signer);
 const[pE,pW,dE,dW,dl]=await Promise.all([e.providerEsteem(),e.providerWpls(),e.depositedEsteem(),e.depositedWpls(),e.deadline()]);
 const now=Math.floor(Date.now()/1000);
 if(now<=Number(dl))return alert("Deadline not passed.");
 const addr=(await signer.getAddress()).toLowerCase();
 showWait(true);let tx;
 if(addr===pE.toLowerCase()&&dE&&!dW)tx=await e.refundEsteem();
 else if(addr===pW.toLowerCase()&&dW&&!dE)tx=await e.refundWpls();
 else return alert("Refund conditions not met.");
 await tx.wait();setStatus("‚úÖ Refunded.");
}catch(e){alert("Refund error: "+(e.message||e));}finally{showWait(false);}};
/* Autofill link param */
const p=new URLSearchParams(location.search);const esc=p.get("escrow");if(esc)$("escrowAddr").value=esc;
</script>
</body>
</html>


