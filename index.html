<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trustless Atomic Swap â€“ PulseChain (369)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.min.js"></script>
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 900px; margin: 28px auto; padding: 0 14px; }
  h2 { margin-top: 0; }
  fieldset { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-bottom: 18px; }
  label { display:block; margin-top:8px; }
  input { width:100%; padding:8px; margin-top:4px; border:1px solid #ccc; border-radius:8px; }
  small { color:#666; }
  button { margin-top:10px; padding:10px 14px; border:0; border-radius:10px; background:#222; color:white; cursor:pointer; }
  button:disabled { opacity:0.5; cursor:not-allowed; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
  #log { background:#f8f8f8; padding:12px; border-radius:10px; white-space:pre-wrap; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .ok { color: #128a23; }
  .warn { color: #a05a00; }
  .err { color: #b00020; }
  a { color:#0a58ca; text-decoration:none; }
</style>
</head>
<body>
<h2>Trustless Atomic Escrow â€“ PulseChain (369)</h2>
<p>Factory-spawned, per-trade escrow with deterministic addresses (CREATE2). No owner. No upgrades. Fully atomic swap.</p>

<button id="connectBtn">1) Connect Wallet</button>
<button id="switchBtn">2) Switch to PulseChain</button>

<fieldset>
  <legend><b>Create / Predict</b></legend>
  <div class="row">
    <div>
      <label>Party A (sender of Token A) <input id="partyA" placeholder="0x..." /></label>
      <label>Token A address
        <input id="tokenA" />
        <small>ESTEEM â€“ pre-filled PulseChain address</small>
      </label>
      <label>Amount A (human units) <input id="amountA" type="number" step="any" placeholder="e.g., 123.45" /></label>
    </div>
    <div>
      <label>Party B (sender of Token B) <input id="partyB" placeholder="0x..." /></label>
      <label>Token B address
        <input id="tokenB" value="0xefd766ccb38eaf1dfd701853bfce31359239f305" />
        <small>eDAI â€“ 18 decimals</small>
      </label>
      <label>Amount B (human units) <input id="amountB" type="number" step="any" placeholder="e.g., 678.90" /></label>
    </div>
  </div>

  <label>Deadline (minutes from now)
    <input id="deadlineMins" type="number" step="1" value="60" />
    <small>Example: 60 = 1 hour Â· 1440 = 1 day</small>
  </label>

  <div class="row">
    <div>
      <label>Factory Address (deployed by you)
        <input id="factoryAddr" placeholder="0x..." />
      </label>
    </div>
    <div>
      <label>Computed Escrow Address
        <input id="predicted" class="mono" readonly />
      </label>
    </div>
  </div>

  <button id="predictBtn">Predict Escrow Address</button>
  <button id="deployBtn">Deploy Escrow</button>
  <div id="preview"></div>
</fieldset>

<fieldset>
  <legend><b>Interact with an existing Escrow</b></legend>
  <label>Escrow Address <input id="escrowAddr" placeholder="0x..." /></label>
  <div class="row">
    <button id="readAllBtn">Read Parameters & Status</button>
    <button id="statusBtn">Refresh Status</button>
  </div>

  <div class="row">
    <div>
      <button id="approveA">Approve A Amount</button>
      <button id="depositA">Deposit A</button>
    </div>
    <div>
      <button id="approveB">Approve B Amount</button>
      <button id="depositB">Deposit B</button>
    </div>
  </div>

  <div class="row">
    <div><button id="settleBtn">Settle (Atomic)</button></div>
    <div><button id="refundBtn">Refund (after deadline)</button></div>
  </div>

  <div id="links"></div>
</fieldset>

<fieldset>
  <legend><b>Log</b></legend>
  <div id="log"></div>
</fieldset>

<script>
/* ---------- CONFIG (PUT YOUR VALUES) ---------- */
const DEFAULT_FACTORY = "0x571594b57fa8E8c2Cd426ABe4D91D2d594755a90";      // ðŸ‘ˆ REPLACE with your deployed factory
const ESTEEM_ADDR     = "0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5";  // ðŸ‘ˆ REPLACE with ESTEEM on PulseChain
const PLS_CHAIN_ID_HEX = "0x171"; // 369 decimal
const PLS_RPC = "https://rpc.pulsechain.com";
const PLS_EXPLORER = "https://explorer.pulsechain.com";
const SOURCIFY_BASE = "https://repo.sourcify.dev/369";

/* ---------- ABIs ---------- */
const FACTORY_ABI = [
  "event SwapCreated(address indexed escrow, address indexed partyA, address indexed partyB)",
  "function predictAddress(address,address,address,address,uint256,uint256,uint256) view returns (address)",
  "function createSwap(address,address,address,address,uint256,uint256,uint256) returns (address)"
];
const ESCROW_ABI = [
  "function partyA() view returns (address)",
  "function partyB() view returns (address)",
  "function tokenA() view returns (address)",
  "function tokenB() view returns (address)",
  "function amountA() view returns (uint256)",
  "function amountB() view returns (uint256)",
  "function deadline() view returns (uint256)",
  "function depositedA() view returns (bool)",
  "function depositedB() view returns (bool)",
  "function status() view returns (bool,bool,uint256,bool)",
  "function depositA()",
  "function depositB()",
  "function settle()",
  "function refund()"
];
const ERC20_ABI = [
  "function name() view returns (string)",
  "function symbol() view returns (string)",
  "function decimals() view returns (uint8)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function approve(address spender, uint256 value) returns (bool)"
];

/* ---------- GLOBALS ---------- */
let provider, signer;

/* ---------- UTIL ---------- */
function $(id){ return document.getElementById(id); }
function a(href, text){ return `<a href="${href}" target="_blank">${text}</a>`; }
function log(msg, cls){ $("log").innerHTML = `<div class="${cls||""}">${msg}</div>\n` + $("log").innerHTML; }
function fmtUnits(v, d){ try { return ethers.formatUnits(v, d); } catch { return v.toString(); } }
async function getTokenMeta(address) {
  const c = new ethers.Contract(address, ERC20_ABI, provider||signer);
  let symbol = address.slice(0,6)+"â€¦"+address.slice(-4);
  let decimals = 18;
  try { symbol = await c.symbol(); } catch {}
  try { decimals = await c.decimals(); } catch {}
  return { symbol, decimals, contract: c };
}
function getFactoryAddr(){ return $("factoryAddr").value.trim() || DEFAULT_FACTORY; }

/* ---------- CONNECT / SWITCH ---------- */
async function connect() {
  try {
    if (!window.ethereum) { log("No wallet found. Install MetaMask or compatible.", "err"); return; }
    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
    if (!accounts || !accounts.length) { log("Connection cancelled.", "warn"); return; }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    const addr = await signer.getAddress();
    log(`âœ… Wallet connected: ${addr}`, "ok");
  } catch (err) {
    log(`Connection error: ${err.message}`, "err");
  }
}
async function switchToPulse(){
  try{
    await ethereum.request({method:"wallet_switchEthereumChain", params:[{chainId:PLS_CHAIN_ID_HEX}]});
    log("Switched to PulseChain", "ok");
  }catch(e){
    if(e.code===4902){
      await ethereum.request({
        method:"wallet_addEthereumChain",
        params:[{chainId:PLS_CHAIN_ID_HEX, chainName:"PulseChain", rpcUrls:[PLS_RPC],
          nativeCurrency:{name:"PLS",symbol:"PLS",decimals:18}, blockExplorerUrls:[PLS_EXPLORER]}]
      });
      log("PulseChain added. Switch again if needed.", "ok");
    } else log(`Switch error: ${e.message}`, "err");
  }
}

/* ---------- FORM â†’ PARAMS (minutes â†’ deadline) ---------- */
async function gatherParams() {
  const tokenA = $("tokenA").value.trim();
  const tokenB = $("tokenB").value.trim();
  const partyA = $("partyA").value.trim();
  const partyB = $("partyB").value.trim();
  const amountA = $("amountA").value || "0";
  const amountB = $("amountB").value || "0";
  const minsFromNow = parseInt($("deadlineMins").value, 10) || 60;
  const deadline = Math.floor(Date.now()/1000) + minsFromNow*60;

  if (!tokenA || !tokenB || !partyA || !partyB) throw new Error("All fields required.");

  const metaA = await getTokenMeta(tokenA);
  const metaB = await getTokenMeta(tokenB);

  const amountAWei = ethers.parseUnits(amountA, metaA.decimals);
  const amountBWei = ethers.parseUnits(amountB, metaB.decimals);

  return { tokenA, tokenB, partyA, partyB, amountAWei, amountBWei, deadline, metaA, metaB };
}

/* ---------- PREDICT / DEPLOY ---------- */
async function predictAddress() {
  try{
    const fAddr = getFactoryAddr();
    const factory = new ethers.Contract(fAddr, FACTORY_ABI, provider||signer);
    const p = await gatherParams();
    const predicted = await factory.predictAddress(
      p.partyA, p.partyB, p.tokenA, p.tokenB, p.amountAWei, p.amountBWei, p.deadline
    );
    $("predicted").value = predicted;

    $("preview").innerHTML = `
      <p><b>Review immutable terms:</b></p>
      <ul class="mono">
        <li>partyA: ${p.partyA}</li>
        <li>partyB: ${p.partyB}</li>
        <li>tokenA: ${p.tokenA} (${p.metaA.symbol}, ${p.metaA.decimals} dp)</li>
        <li>amountA: ${fmtUnits(p.amountAWei, p.metaA.decimals)} ${p.metaA.symbol}</li>
        <li>tokenB: ${p.tokenB} (${p.metaB.symbol}, ${p.metaB.decimals} dp)</li>
        <li>amountB: ${fmtUnits(p.amountBWei, p.metaB.decimals)} ${p.metaB.symbol}</li>
        <li>deadline: ${p.deadline} (${new Date(p.deadline*1000).toLocaleString()})</li>
      </ul>
      <p>Predicted Escrow: <code class="mono">${predicted}</code><br>
        ${a(`${PLS_EXPLORER}/address/${predicted}`, "View on Explorer")}
      </p>`;
    log("Predicted address computed.", "ok");
  }catch(e){ log(`Predict error: ${e.message}`, "err"); }
}

async function deployEscrow() {
  try{
    if(!signer) await connect();
    const fAddr = getFactoryAddr();
    const factory = new ethers.Contract(fAddr, FACTORY_ABI, signer);
    const p = await gatherParams();

    const tx = await factory.createSwap(
      p.partyA, p.partyB, p.tokenA, p.tokenB, p.amountAWei, p.amountBWei, p.deadline
    );
    log(`Deploy tx sent: ${tx.hash}`, "warn");
    const rcpt = await tx.wait();

    // Parse event
    let escrow = $("predicted").value;
    try {
      const iface = new ethers.Interface(FACTORY_ABI);
      for (const lg of rcpt.logs) {
        try {
          const parsed = iface.parseLog(lg);
          if (parsed && parsed.name === "SwapCreated") { escrow = parsed.args.escrow; break; }
        } catch {}
      }
    } catch {}

    $("escrowAddr").value = escrow;
    $("links").innerHTML = `
      <p>
        ${a(`${PLS_EXPLORER}/address/${escrow}`, "Escrow on Explorer")} |
        ${a(`${SOURCIFY_BASE}/${fAddr}/`, "Verify Factory on Sourcify")}
      </p>`;
    log(`Escrow deployed at ${escrow}`, "ok");
  }catch(e){ log(`Deploy error: ${e.message}`, "err"); }
}

/* ---------- INTERACTION ---------- */
async function readAll() {
  try{
    const escrow = $("escrowAddr").value.trim();
    if (!escrow) return log("Enter escrow address.", "err");
    const c = new ethers.Contract(escrow, ESCROW_ABI, provider||signer);
    const [a1, b1, ta, tb, aAmt, bAmt, dl, depA, depB] = await Promise.all([
      c.partyA(), c.partyB(), c.tokenA(), c.tokenB(), c.amountA(), c.amountB(), c.deadline(), c.depositedA(), c.depositedB()
    ]);
    const metaA = await getTokenMeta(ta);
    const metaB = await getTokenMeta(tb);
    const [,, timeLeft, finished] = await c.status();

    $("links").innerHTML = `
      <p>
        ${a(`${PLS_EXPLORER}/address/${escrow}`, "Escrow on Explorer")} |
        ${a(`${PLS_EXPLORER}/address/${ta}`, `TokenA (${metaA.symbol})`)} |
        ${a(`${PLS_EXPLORER}/address/${tb}`, `TokenB (${metaB.symbol})`)}
      </p>`;

    log(
`Escrow params:
  partyA: ${a1}
  partyB: ${b1}
  tokenA: ${ta} (${metaA.symbol}, ${metaA.decimals})
  amountA: ${fmtUnits(aAmt, metaA.decimals)} ${metaA.symbol}
  tokenB: ${tb} (${metaB.symbol}, ${metaB.decimals})
  amountB: ${fmtUnits(bAmt, metaB.decimals)} ${metaB.symbol}
  deadline: ${dl} (${new Date(Number(dl)*1000).toLocaleString()})

Status:
  depositedA: ${depA}
  depositedB: ${depB}
  timeLeft: ${Number(timeLeft)}s
  finished: ${finished}
`, "ok");
  }catch(e){ log(`Read error: ${e.message}`, "err"); }
}
async function refreshStatus() {
  try{
    const escrow = $("escrowAddr").value.trim();
    if (!escrow) return log("Enter escrow address.", "err");
    const c = new ethers.Contract(escrow, ESCROW_ABI, provider||signer);
    const [depA, depB, timeLeft, finished] = await c.status();
    log(`Status â†’ A:${depA} B:${depB} timeLeft:${Number(timeLeft)}s finished:${finished}`, "ok");
  }catch(e){ log(`Status error: ${e.message}`, "err"); }
}
async function approve(side) {
  try{
    if (!signer) await connect();
    const escrow = $("escrowAddr").value.trim();
    if (!escrow) return log("Enter escrow address.", "err");
    const c = new ethers.Contract(escrow, ESCROW_ABI, provider||signer);
    const [ta, tb, aAmt, bAmt] = await Promise.all([c.tokenA(), c.tokenB(), c.amountA(), c.amountB()]);
    const tokenAddr = side === "A" ? ta : tb;
    const need = side === "A" ? aAmt : bAmt;

    const token = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
    const my = await signer.getAddress();
    const allowance = await token.allowance(my, escrow);
    if (allowance >= need) { log(`Allowance already sufficient for side ${side}.`, "ok"); return; }
    const tx = await token.approve(escrow, need);
    log(`Approve ${side} tx: ${tx.hash}`, "warn");
    await tx.wait();
    log(`Approved ${side}.`, "ok");
  }catch(e){ log(`Approve ${side} error: ${e.message}`, "err"); }
}
async function doDeposit(side) {
  try{
    if (!signer) await connect();
    const escrow = $("escrowAddr").value.trim();
    if (!escrow) return log("Enter escrow address.", "err");
    const c = new ethers.Contract(escrow, ESCROW_ABI, signer);
    const tx = await (side==="A" ? c.depositA() : c.depositB());
    log(`Deposit ${side} tx: ${tx.hash}`, "warn");
    await tx.wait();
    log(`Deposited ${side}.`, "ok");
  }catch(e){ log(`Deposit ${side} error: ${e.message}`, "err"); }
}
async function settle() {
  try{
    if (!signer) await connect();
    const escrow = $("escrowAddr").value.trim();
    const c = new ethers.Contract(escrow, ESCROW_ABI, signer);
    const tx = await c.settle();
    log(`Settle tx: ${tx.hash}`, "warn");
    await tx.wait();
    log("Settled atomically.", "ok");
  }catch(e){ log(`Settle error: ${e.message}`, "err"); }
}
async function refund() {
  try{
    if (!signer) await connect();
    const escrow = $("escrowAddr").value.trim();
    const c = new ethers.Contract(escrow, ESCROW_ABI, signer);
    const tx = await c.refund();
    log(`Refund tx: ${tx.hash}`, "warn");
    await tx.wait();
    log("Refund executed (post-deadline).", "ok");
  }catch(e){ log(`Refund error: ${e.message}`, "err"); }
}

/* ---------- WIRE EVENTS AFTER DOM READY ---------- */
window.addEventListener("DOMContentLoaded", () => {
  // Pre-fill factory + ESTEEM
  if (DEFAULT_FACTORY) $("factoryAddr").value = DEFAULT_FACTORY;
  if (ESTEEM_ADDR)     $("tokenA").value    = ESTEEM_ADDR;

  $("connectBtn").addEventListener("click", connect);
  $("switchBtn").addEventListener("click", switchToPulse);
  $("predictBtn").addEventListener("click", predictAddress);
  $("deployBtn").addEventListener("click", deployEscrow);

  $("readAllBtn").addEventListener("click", readAll);
  $("statusBtn").addEventListener("click", refreshStatus);
  $("approveA").addEventListener("click", () => approve("A"));
  $("approveB").addEventListener("click", () => approve("B"));
  $("depositA").addEventListener("click", () => doDeposit("A"));
  $("depositB").addEventListener("click", () => doDeposit("B"));
  $("settleBtn").addEventListener("click", settle);
  $("refundBtn").addEventListener("click", refund);
});
</script>
</body>
</html>
