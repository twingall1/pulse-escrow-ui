<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pulsecrow ‚Äì One-Sided Escrow (ESTEEM ‚áÑ PLS)</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;max-width:760px;margin:32px auto;padding:18px;background:#f8fafc;color:#111}
  h1,h2{margin:0 0 8px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:14px 0}
  input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #cbd5e1;font-size:15px}
  button{background:#2563eb;color:#fff;border:none;font-weight:600;cursor:pointer}
  button:disabled{background:#9ca3af;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center}
  .muted{color:#555;font-size:13px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  #overlay{position:fixed;inset:0;background:rgba(255,255,255,0.82);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:99999}
  .spinner{border:4px solid #ddd;border-top:4px solid #2563eb;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin-bottom:12px}
  @keyframes spin{100%{transform:rotate(360deg)}}
  #instructions{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px;font-size:14px;margin-top:16px;line-height:1.55}
  .checkmark{color:green;font-size:18px;margin-left:6px;display:none}
  .done .checkmark{display:inline}
</style>
</head>
<body>
<h1>Pulsecrow</h1>
<p class="muted">
  Seller creates escrow contract and deposits <b>ESTEEM</b>; Buyer pays <b>PLS</b> in one click.<br>
  <a href="#instructions" style="color:#2563eb;text-decoration:none;">üìò View brief instructions</a>
</p>

<div class="card">
  <button id="connect">üîó Connect Wallet</button>
  <div id="who" class="muted"></div>
</div>

<div class="card">
  <h2>Create Escrow</h2>
  <!-- (seller is always the connected wallet; no seller input shown) -->
  <input id="buyer" placeholder="Buyer address (will pay PLS)">
  <div class="row">
    <input id="esteemAmt" placeholder="ESTEEM amount (e.g. 15)">
    <input id="pricePLS" placeholder="Price in PLS (e.g. 2000)">
  </div>
  <input id="deadlineMins" placeholder="Deadline minutes from now (e.g. 30)">
  <button id="create" disabled>Create Escrow</button>
  <div id="created" class="muted"></div>
</div>

<div class="card">
  <h2>Verify / Use Escrow</h2>
  <input id="escrow" placeholder="Escrow address (or open from shared link)">
  <button id="load">üîç Load On-Chain Details</button>
  <div id="verifystatus" class="muted"></div>
  <pre id="onchain" class="mono"></pre>

  <div class="row" style="margin-top:8px;">
    <div><button id="approveEsteem" disabled>Seller: Approve ESTEEM</button><span class="checkmark" id="checkApprove">‚úÖ</span></div>
    <div><button id="depositEsteem" disabled>Seller: Deposit ESTEEM</button><span class="checkmark" id="checkDeposit">‚úÖ</span></div>
  </div>

  <div class="row">
    <div><button id="buy" disabled>Buyer: Buy (send PLS)</button><span class="checkmark" id="checkBuy">‚úÖ</span></div>
    <div><button id="refund" disabled>Seller: Refund (after deadline)</button><span class="checkmark" id="checkRefund">‚úÖ</span></div>
  </div>
</div>

<div class="card">
  <h2>Status</h2>
  <div id="status" class="mono"></div>
  <div id="turn" style="font-style:italic;color:#444;margin-top:6px;"></div>
</div>

<div id="overlay"><div class="spinner"></div><div>‚è≥ Waiting for confirmation‚Ä¶</div></div>

<div id="instructions">
  <b>Quick guide:</b><br><br>
  1Ô∏è‚É£ <b>Esteem seller</b> connects wallet and creates the escrow (enter buyer address, ESTEEM amount, price in PLS, and deadline).<br>
  2Ô∏è‚É£ Share the link or escrow address with the <b>Buyer</b>.<br>
  3Ô∏è‚É£ <b>Both</b> click ‚ÄúLoad On-Chain Details‚Äù and check the printed numbers match what was agreed.<br>
  4Ô∏è‚É£ <b>Seller</b> clicks ‚ÄúApprove ESTEEM‚Äù, then ‚ÄúDeposit ESTEEM.‚Äù<br>
  5Ô∏è‚É£ Once deposited, <b>Buyer</b> clicks ‚ÄúBuy (send PLS)‚Äù to complete the swap.<br>
  6Ô∏è‚É£ If the Buyer never buys and the deadline passes, <b>Seller</b> clicks ‚ÄúRefund.‚Äù<br><br>
  Always verify the on-chain values before acting. Pulsecrow never holds funds ‚Äî only the escrow contract does.
</div>

<script>
/*** CONFIG (unchanged) ***/
const FACTORY="0xb42529b2A66FD430a872788c83b10B285886b963";
const ESTEEM ="0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5"; // lowercase to avoid EIP-1191 checksum quirks
const DEC=18;
const READONLY_RPC="https://rpc.pulsechain.com";

/*** ABIs (unchanged) ***/
const factoryABI=[
 "function createEscrow(address seller,address buyer,uint256 esteemAmount,uint256 pricePLS,uint256 deadline) external returns(address)",
 "event EscrowCreated(address indexed creator,address escrow,address seller,address buyer,uint256 esteemAmount,uint256 pricePLS,uint256 deadline)"
];
const escrowABI=[
 "function seller() view returns(address)",
 "function buyer() view returns(address)",
 "function esteemAmount() view returns(uint256)",
 "function pricePLS() view returns(uint256)",
 "function deadline() view returns(uint256)",
 "function deposited() view returns(bool)",
 "function settled() view returns(bool)",
 "function depositEsteem() external",
 "function buy() external payable",
 "function refund() external"
];
const erc20ABI=["function approve(address,uint256) returns(bool)"];

/*** Helpers (unchanged) ***/
const $=id=>document.getElementById(id);
const toWei=v=>ethers.parseUnits(String(v),DEC);
const toUnits=b=>Number(ethers.formatUnits(b,DEC));
const showWait=b=>$("overlay").style.display=b?"flex":"none";
const setStatus=m=>$("status").textContent=m;
const setTurn=m=>$("turn").textContent=m;

/*** State ***/
let providerRO=new ethers.JsonRpcProvider(READONLY_RPC);
let provider,signer,me;

/*** NEW: centralised button gating (tiny, non-invasive) ***/
function gateButtons({meAddr,seller,buyer,dep,set,deadline}) {
  const now = Math.floor(Date.now()/1000);
  const isSeller = meAddr && seller && meAddr.toLowerCase()===seller.toLowerCase();
  const isBuyer  = meAddr && buyer  && meAddr.toLowerCase()===buyer.toLowerCase();

  $("approveEsteem").disabled = !(isSeller && !dep && !set);
  $("depositEsteem").disabled = !(isSeller && !dep && !set);
  $("buy").disabled           = !(isBuyer  &&  dep && !set);
  $("refund").disabled        = !(isSeller &&  dep && !set && now>Number(deadline));

  // Turn hint
  let hint="";
  if(!dep && !set)                 hint="üë§ Seller: approve + deposit ESTEEM.";
  else if(dep && !set)             hint="üë§ Buyer: verify & click Buy to send PLS.";
  else if(set)                     hint="‚úÖ Complete. Both sides settled.";
  else if(now>Number(deadline))    hint="‚è≥ Deadline passed ‚Äî Seller may refund.";
  setTurn(hint);
}

/*** Connect ***/
$("connect").onclick=async()=>{
  if(!window.ethereum) return alert("Install MetaMask or OKX Wallet");
  provider=new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts",[]);
  signer=await provider.getSigner();
  me=await signer.getAddress();
  $("who").textContent=`Connected: ${me}`;
  $("create").disabled=false;

  // üîí IMPORTANT: do NOT autofill any "seller" input when user opened a shared link (?escrow=...)
  // (Keeping this guard even though there is no seller input ‚Äî safe no-op.)
  const escrowParam=new URLSearchParams(location.search).get("escrow");
  if(!escrowParam){
    const sellerInput=document.getElementById("seller");
    if(sellerInput){ sellerInput.value = me; }
  }

  // If an escrow address is present, auto-refresh state when accounts/chain change
  if(window.ethereum?.on){
    window.ethereum.on('accountsChanged', async ()=>{
      if(!provider) return;
      signer=await provider.getSigner();
      me=await signer.getAddress();
      $("who").textContent=`Connected: ${me}`;
      if($("escrow").value && ethers.isAddress($("escrow").value)) { await loadEscrow(); }
    });
    window.ethereum.on('chainChanged', async ()=>{
      if($("escrow").value && ethers.isAddress($("escrow").value)) { await loadEscrow(); }
    });
  }
};

/*** Create (unchanged, except we keep seller = me) ***/
$("create").onclick=async()=>{
 try{
  const f=new ethers.Contract(FACTORY,factoryABI,signer);
  const seller=me.trim(),buyer=$("buyer").value.trim();
  if(!ethers.isAddress(buyer)) return alert("Bad buyer address");
  const esteemAmt=parseFloat($("esteemAmt").value),price=parseFloat($("pricePLS").value);
  if(!(esteemAmt>0 && price>0)) return alert("Amounts invalid");
  const mins=parseInt($("deadlineMins").value)||30;
  const dl=Math.floor(Date.now()/1000)+mins*60;

  const predicted=await f.createEscrow.staticCall(seller,buyer,toWei(esteemAmt),toWei(price),dl);
  showWait(true);
  const tx=await f.createEscrow(seller,buyer,toWei(esteemAmt),toWei(price),dl);
  const rc=await tx.wait();
  let esc; try{
    esc=rc.logs.map(l=>f.interface.parseLog(l)).find(p=>p?.name==="EscrowCreated")?.args?.escrow;
  }catch{ esc=predicted; }

  const link=`${location.origin}${location.pathname}?escrow=${esc}`;
  $("created").innerHTML=`‚úÖ Escrow created: <code>${esc}</code><br>Share this link with buyer:<br><a href="${link}" target="_blank">${link}</a>`;
  $("escrow").value=esc;
  setStatus("Escrow ready. Seller approves + deposits ESTEEM, then Buyer buys with PLS.");
 }catch(e){ alert("Create error: "+(e?.reason||e?.message||e)); }
 finally{ showWait(false); }
};

/*** Load / Verify (slight tweak: call gateButtons after reading state) ***/
$("load").onclick=async()=>{ await loadEscrow(); };

async function loadEscrow(){
 try{
  const esc=$("escrow").value.trim(); if(!ethers.isAddress(esc)) return alert("Invalid address");
  const e=new ethers.Contract(esc,escrowABI,provider||providerRO);
  const [s,b,aE,pPLS,dl,dep,set]=await Promise.all([
    e.seller(),e.buyer(),e.esteemAmount(),e.pricePLS(),e.deadline(),e.deposited(),e.settled()
  ]);
  const lines=[
   `seller:       ${s}`,
   `buyer:        ${b}`,
   `esteemAmount: ${toUnits(aE)}`,
   `pricePLS:     ${toUnits(pPLS)}`,
   `deadline:     ${new Date(Number(dl)*1000).toUTCString()}`,
   `deposited:    ${dep}`,
   `settled:      ${set}`
  ];
  $("onchain").textContent=lines.join("\n");
  $("verifystatus").textContent="‚úÖ On-chain details loaded.";

  // üîß Only here do we decide who can press what, based on on-chain + connected addr
  gateButtons({meAddr:me, seller:s, buyer:b, dep, set, deadline:dl});
 }catch(e){
  $("verifystatus").textContent="‚ùå Verify error: "+(e?.message||e);
 }
}

/*** Approve ESTEEM (unchanged, plus checkmark UI) ***/
$("approveEsteem").onclick=async()=>{
 try{
  const esc=$("escrow").value.trim(); const e=new ethers.Contract(esc,escrowABI,signer);
  const amt=await e.esteemAmount(); const token=new ethers.Contract(ESTEEM,erc20ABI,signer);
  showWait(true);
  const tx=await token.approve(esc,amt); await tx.wait();
  setStatus("‚úÖ Approved ESTEEM.");
  $("approveEsteem").disabled=true;
  $("checkApprove").style.display="inline";
 }catch(e){ alert("Approve error: "+(e?.reason||e?.message||e)); }
 finally{ showWait(false); }
};

/*** Deposit ESTEEM (unchanged, plus checkmark UI) ***/
$("depositEsteem").onclick=async()=>{
 try{
  const esc=$("escrow").value.trim(); const e=new ethers.Contract(esc,escrowABI,signer);
  showWait(true);
  const tx=await e.depositEsteem(); await tx.wait();
  setStatus("‚úÖ Deposited ESTEEM.");
  $("depositEsteem").disabled=true;
  $("checkDeposit").style.display="inline";

  // After seller deposits, re-read & re-gate (so buyer‚Äôs ‚ÄúBuy‚Äù becomes enabled when they connect)
  await loadEscrow();
 }catch(e){ alert("Deposit error: "+(e?.reason||e?.message||e)); }
 finally{ showWait(false); }
};

/*** Buy (unchanged, plus checkmark UI) ***/
$("buy").onclick=async()=>{
 try{
  const esc=$("escrow").value.trim(); const e=new ethers.Contract(esc,escrowABI,signer);
  const price=await e.pricePLS(); showWait(true);
  const tx=await e.buy({value:price}); await tx.wait();
  setStatus("‚úÖ Purchased: PLS ‚Üí Seller, ESTEEM ‚Üí Buyer.");
  $("buy").disabled=true; $("checkBuy").style.display="inline";
  await loadEscrow();
 }catch(e){ alert("Buy error: "+(e?.reason||e?.message||e)); }
 finally{ showWait(false); }
};

/*** Refund (unchanged, plus checkmark UI) ***/
$("refund").onclick=async()=>{
 try{
  const esc=$("escrow").value.trim(); const e=new ethers.Contract(esc,escrowABI,signer);
  showWait(true);
  const tx=await e.refund(); await tx.wait();
  setStatus("‚úÖ Refunded ESTEEM to Seller.");
  $("refund").disabled=true; $("checkRefund").style.display="inline";
  await loadEscrow();
 }catch(e){ alert("Refund error: "+(e?.reason||e?.message||e)); }
 finally{ showWait(false); }
};

/*** Autofill from ?escrow= ***/
const params=new URLSearchParams(location.search);
const esc=params.get("escrow");
if(esc){ $("escrow").value=esc; }
</script>
</body>
</html>
