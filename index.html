<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Pulsecrow ‚Äì One-Sided Escrow (ESTEEM ‚Üí PLS)</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;max-width:760px;margin:32px auto;padding:18px;background:#f8fafc;color:#111}
  h1,h2{margin:0 0 8px}.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:14px 0}
  input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #cbd5e1;font-size:15px}
  button{background:#2563eb;color:#fff;border:none;font-weight:600;cursor:pointer}
  button:disabled{background:#9ca3af;cursor:not-allowed}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .muted{color:#555;font-size:13px}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  #overlay{position:fixed;inset:0;background:rgba(255,255,255,0.82);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:99999}
  .spinner{border:4px solid #ddd;border-top:4px solid #2563eb;border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin-bottom:12px}
  @keyframes spin{100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<h1>Pulsecrow</h1>
<p class="muted">One-sided escrow: Seller escrows <b>ESTEEM</b>, Buyer pays <b>PLS</b> in one click.</p>

<div class="card">
  <button id="connect">üîó Connect Wallet</button>
  <div id="who" class="muted"></div>
</div>

<div class="card">
  <h2>Create Escrow</h2>
  <div class="row">
    <input id="seller" placeholder="Seller address (will deposit ESTEEM)">
    <input id="buyer" placeholder="Buyer address (only this address can buy)">
  </div>
  <div class="row">
    <input id="esteemAmt" placeholder="ESTEEM amount (e.g. 15)">
    <input id="pricePLS"  placeholder="Price in PLS (e.g. 2000)">
  </div>
  <input id="deadlineMins" placeholder="Deadline minutes from now (e.g. 30)">
  <button id="create" disabled>Create Escrow</button>
  <div id="created" class="muted"></div>
</div>

<div class="card">
  <h2>Verify / Use Escrow</h2>
  <input id="escrow" placeholder="Escrow address (or open from shared link)">
  <button id="load">üîç Load On-Chain Details</button>
  <div id="verifystatus" class="muted"></div>
  <pre id="onchain" class="mono"></pre>

  <div class="row" style="margin-top:8px;">
    <button id="approveEsteem" disabled>Seller: Approve ESTEEM</button>
    <button id="depositEsteem" disabled>Seller: Deposit ESTEEM</button>
  </div>

  <button id="buy" disabled>Buyer: Buy (send PLS)</button>
  <button id="refund" disabled>Seller: Refund (after deadline)</button>
</div>

<div class="card">
  <h2>Status</h2>
  <div id="status" class="mono"></div>
</div>

<div id="overlay"><div class="spinner"></div><div>‚è≥ Waiting for confirmation‚Ä¶</div></div>

<script>
/*** CONFIG ***/
const READONLY_RPC = "https://rpc.pulsechain.com";
const FACTORY = "0xd4f4606BA258156b0aB8C70F0678Ded67AF8577e"; // TODO: replace after deploy
const ESTEEM = "0x9fdce721c528e6dbc4f494f3e80b9b28a3059ab5"; // lowercase to dodge ethers v6 EIP-1191 quirks
const DEC = 18;

/*** ABIs ***/
const factoryABI = [
  "function createEscrow(address seller,address buyer,uint256 esteemAmount,uint256 pricePLS,uint256 deadline) external returns (address)",
  "event EscrowCreated(address indexed creator,address escrow,address seller,address buyer,uint256 esteemAmount,uint256 pricePLS,uint256 deadline)"
];
const escrowABI = [
  "function seller() view returns(address)",
  "function buyer() view returns(address)",
  "function esteemAmount() view returns(uint256)",
  "function pricePLS() view returns(uint256)",
  "function deadline() view returns(uint256)",
  "function deposited() view returns(bool)",
  "function settled() view returns(bool)",
  "function depositEsteem() external",
  "function buy() external payable",
  "function refund() external"
];
const erc20ABI = [
  "function allowance(address owner,address spender) view returns(uint256)",
  "function approve(address spender,uint256 amount) returns(bool)"
];

/*** State ***/
let providerRO = new ethers.JsonRpcProvider(READONLY_RPC);
let provider, signer, me;

/*** Helpers ***/
const $ = id => document.getElementById(id);
const toWei = v => ethers.parseUnits(String(v), DEC);
const toUnits = bn => Number(ethers.formatUnits(bn, DEC));
const showWait = b => $("overlay").style.display = b ? "flex" : "none";
const setStatus = m => $("status").textContent = m;

/*** Connect ***/
$("connect").onclick = async () => {
  if (!window.ethereum) return alert("Install MetaMask or OKX");
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  me = await signer.getAddress();
  $("who").textContent = `Connected: ${me}`;
  $("create").disabled = true;

  // convenience: prefill seller with your address
  $("seller").value = me;
  $("create").disabled = false;
};

/*** Create ***/
$("create").onclick = async () => {
  try {
    if (!signer) return alert("Connect wallet first");
    if (FACTORY === "0x0000000000000000000000000000000000000000") return alert("Set FACTORY address in index.html");

    const seller = $("seller").value.trim();
    const buyer  = $("buyer").value.trim();
    if (!ethers.isAddress(seller) || !ethers.isAddress(buyer)) return alert("Enter valid seller & buyer addresses");

    const esteemAmt = parseFloat($("esteemAmt").value);
    const pricePLS  = parseFloat($("pricePLS").value);
    if (!(esteemAmt>0 && pricePLS>0)) return alert("Enter positive amounts");

    const mins = parseInt($("deadlineMins").value) || 30;
    const deadline = Math.floor(Date.now()/1000) + mins*60;

    const f = new ethers.Contract(FACTORY, factoryABI, signer);

    // Predict (static call) + Create
    const predicted = await f.createEscrow.staticCall(seller, buyer, toWei(esteemAmt), toWei(pricePLS), deadline);
    console.log("Predicted:", predicted);

    showWait(true);
    const tx = await f.createEscrow(seller, buyer, toWei(esteemAmt), toWei(pricePLS), deadline);
    console.log("Create tx:", tx.hash);
    const rc = await tx.wait();

    // Parse event, fallback to predicted
    let esc;
    try {
      const parsed = rc.logs.map(l => f.interface.parseLog(l)).find(p => p?.name === "EscrowCreated");
      esc = parsed?.args?.escrow;
    } catch { esc = predicted; }

    const link = `${location.origin}${location.pathname}?escrow=${esc}`;
    $("created").innerHTML = `‚úÖ Escrow: <code>${esc}</code><br>Share: <a href="${link}" target="_blank">${link}</a>`;
    $("escrow").value = esc;
    setStatus("Escrow created. Seller should approve & deposit ESTEEM. Buyer can then buy with PLS.");
  } catch (e) {
    console.error(e);
    alert("Create error: " + (e?.reason || e?.message || e));
  } finally {
    showWait(false);
  }
};

/*** Load / Verify ***/
$("load").onclick = async () => {
  try {
    const esc = $("escrow").value.trim();
    if (!ethers.isAddress(esc)) return alert("Enter a valid escrow address");
    const e = new ethers.Contract(esc, escrowABI, provider || providerRO);

    const [s, b, aE, pPLS, dl, dep, set] = await Promise.all([
      e.seller(), e.buyer(), e.esteemAmount(), e.pricePLS(), e.deadline(), e.deposited(), e.settled()
    ]);

    const lines = [
      `seller:       ${s}`,
      `buyer:        ${b}`,
      `esteemAmount: ${toUnits(aE)} (raw ${aE})`,
      `pricePLS:     ${toUnits(pPLS)} (raw ${pPLS})`,
      `deadline:     ${new Date(Number(dl)*1000).toUTCString()} (unix ${dl})`,
      `deposited:    ${dep}`,
      `settled:      ${set}`
    ];
    $("onchain").textContent = lines.join("\n");
    $("verifystatus").textContent = "‚úÖ Loaded on-chain details.";

    // Gate buttons based on who you are + state
    const am = me ? me.toLowerCase() : "";
    const isSeller = am === s.toLowerCase();
    const isBuyer  = am === b.toLowerCase();

    $("approveEsteem").disabled  = !(isSeller && !dep && !set);
    $("depositEsteem").disabled  = !(isSeller && !dep && !set);
    $("buy").disabled            = !(isBuyer && dep && !set);
    $("refund").disabled         = !(isSeller && dep && !set && (Math.floor(Date.now()/1000) > Number(dl)));
  } catch (e) {
    console.error(e);
    $("verifystatus").textContent = "‚ùå Verify error: " + (e?.message || e);
  }
};

/*** Seller: Approve ESTEEM ***/
$("approveEsteem").onclick = async () => {
  try {
    if (!signer) return alert("Connect wallet first");
    const esc = $("escrow").value.trim();
    const e = new ethers.Contract(esc, escrowABI, signer);
    const amount = await e.esteemAmount();
    const token = new ethers.Contract(ESTEEM, erc20ABI, signer);

    showWait(true);
    const tx = await token.approve(esc, amount);
    console.log("Approve ESTEEM tx:", tx.hash);
    await tx.wait();
    setStatus("‚úÖ Approved ESTEEM.");
  } catch (e) {
    console.error(e);
    alert("Approve error: " + (e?.reason || e?.message || e));
  } finally {
    showWait(false);
  }
};

/*** Seller: Deposit ESTEEM ***/
$("depositEsteem").onclick = async () => {
  try {
    if (!signer) return alert("Connect wallet first");
    const esc = $("escrow").value.trim();
    const e = new ethers.Contract(esc, escrowABI, signer);

    showWait(true);
    const tx = await e.depositEsteem();
    console.log("Deposit ESTEEM tx:", tx.hash);
    await tx.wait();
    setStatus("‚úÖ ESTEEM deposited.");
  } catch (e) {
    console.error(e);
    alert("Deposit error: " + (e?.reason || e?.message || e));
  } finally {
    showWait(false);
  }
};

/*** Buyer: Buy (send PLS) ***/
$("buy").onclick = async () => {
  try {
    if (!signer) return alert("Connect wallet first");
    const esc = $("escrow").value.trim();
    const e = new ethers.Contract(esc, escrowABI, signer);
    const price = await e.pricePLS();

    showWait(true);
    const tx = await e.buy({ value: price });
    console.log("Buy tx:", tx.hash);
    await tx.wait();
    setStatus("‚úÖ Purchased: PLS ‚Üí Seller, ESTEEM ‚Üí Buyer.");
  } catch (e) {
    console.error(e);
    alert("Buy error: " + (e?.reason || e?.message || e));
  } finally {
    showWait(false);
  }
};

/*** Seller: Refund (after deadline) ***/
$("refund").onclick = async () => {
  try {
    if (!signer) return alert("Connect wallet first");
    const esc = $("escrow").value.trim();
    const e = new ethers.Contract(esc, escrowABI, signer);

    showWait(true);
    const tx = await e.refund();
    console.log("Refund tx:", tx.hash);
    await tx.wait();
    setStatus("‚úÖ Refunded ESTEEM to Seller.");
  } catch (e) {
    console.error(e);
    alert("Refund error: " + (e?.reason || e?.message || e));
  } finally {
    showWait(false);
  }
};

/*** Autofill from ?escrow= ***/
const params = new URLSearchParams(location.search);
const esc = params.get("escrow");
if (esc) $("escrow").value = esc;
</script>
</body>
</html>
